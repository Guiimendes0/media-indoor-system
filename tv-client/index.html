<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Indoor Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        #player-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #media-display, #video-display, #web-display {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: none;
        }
        
        #youtube-display {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Tela de Autentica√ß√£o Atualizada */
        #auth-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            color: #333;
        }

        .logo-container {
            margin-bottom: 20px;
        }

        .logo-image {
            max-width: 200px;
            max-height: 100px;
            margin-bottom: 15px;
        }

        .auth-container h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .auth-container p {
            color: #666;
            margin-bottom: 20px;
        }

        .auth-code-display {
            background: #f8f9fa;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .auth-code {
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 8px;
            margin: 10px 0;
        }

        .code-expiry {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 10px;
            font-weight: bold;
        }

        .device-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            text-align: left;
        }

        .device-info strong {
            color: #2c3e50;
        }

        /* Status e controles */
        #status-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
            border: 1px solid #333;
        }
        
        #connection-error {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 100;
            padding: 20px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
            z-index: 50;
        }
        
        .countdown {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }

        .debug-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #ccc;
            z-index: 100;
        }

        .sync-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            z-index: 200;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="player-container">
        <!-- Tela de Autentica√ß√£o Atualizada -->
        <div id="auth-screen">
            <div class="auth-container">
                <div class="logo-container">
                    <!-- Espa√ßo para logo - substitua o src pela URL da sua logo -->
                    <img src="../tv-client/assets/Pantanera-logo.png" 
                         alt="Media Indoor Logo" class="logo-image">
                </div>
                
                <h1>Pantaneira Media Indoor</h1>
                <p>Use o c√≥digo abaixo para cadastrar este dispositivo no painel administrativo</p>
                
                <div class="auth-code-display">
                    <div style="color: #666; margin-bottom: 10px;">C√≥digo de Ativa√ß√£o:</div>
                    <div class="auth-code" id="generatedAuthCode">------</div>
                    <div class="code-expiry" id="codeExpiry">Gerando novo c√≥digo...</div>
                </div>
                
                <div class="device-info">
                    <strong>Identificador do Dispositivo:</strong> <span id="device-mac">Carregando...</span><br>
                    <strong>Status:</strong> <span id="device-status">N√£o autenticado</span><br>
                    <small>Este c√≥digo √© v√°lido por 5 minutos. Ap√≥s esse per√≠odo, um novo c√≥digo ser√° gerado automaticamente.</small>
                </div>

                <div id="auth-error" style="color: #e74c3c; margin-top: 15px; display: none;"></div>
            </div>
        </div>
        
        <!-- Tela de Erro -->
        <div id="connection-error" class="hidden">
            <h1 style="color: #e74c3c; margin-bottom: 20px; font-size: 2rem;">‚ùå Erro de Conex√£o</h1>
            <p style="font-size: 1.2rem; margin-bottom: 10px;" id="error-message">Erro ao conectar com o servidor</p>
            <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üîÑ Tentar Novamente
            </button>
        </div>
        
        <!-- Loading -->
        <div class="loading hidden" id="loading">üîÑ Carregando...</div>

        <!-- Notifica√ß√£o de Sincroniza√ß√£o -->
        <div class="sync-notification hidden" id="syncNotification">
            üîÑ Sincronizando...
        </div>
        
        <!-- M√≠dias -->
        <img id="media-display" class="hidden" alt="M√≠dia">
        <video id="video-display" class="hidden" loop></video>
        <iframe id="youtube-display" class="hidden" allowfullscreen></iframe>
        <iframe id="web-display" class="hidden" allowfullscreen></iframe>
        
        <!-- Status -->
        <div id="status-overlay" class="hidden">
            <div style="margin-bottom: 5px;">‚úÖ <strong id="device-name">-</strong></div>
            <div style="margin-bottom: 5px;">üé¨ <span id="current-media">-</span></div>
            <div style="margin-bottom: 5px;">‚è±Ô∏è <span id="media-time">-</span></div>
            <div>üîó <span id="ws-status">Desconectado</span></div>
        </div>
        
        <!-- Countdown -->
        <div class="countdown hidden" id="countdown">
            Pr√≥xima m√≠dia em: <span id="countdown-timer">0</span>s
        </div>
        
        <!-- Debug -->
        <div class="debug-panel hidden" id="debug-panel">
            <div>Media Indoor Player</div>
            <div id="debug-info">Conectando...</div>
        </div>
    </div>

    <script>
        class MediaPlayer {
            constructor() {
                this.serverUrl = window.location.origin;
                this.wsUrl = `ws://${window.location.host}`;
                this.currentMediaIndex = 0;
                this.mediaList = [];
                this.deviceInfo = null;
                this.updateInterval = 30000;
                this.currentTimeout = null;
                this.currentCountdown = null;
                this.deviceMac = null;
                this.currentMedia = null;
                this.ws = null;
                this.deviceId = null;
                this.isSyncing = false;
                this.mediaStartTime = null;
                this.isPlaying = false;
                this.reconnectAttempts = 0;
                this.authCode = null;
                this.codeExpiry = null;
                this.codeGenerationInterval = null;
                
                // Elementos DOM
                this.authScreen = document.getElementById('auth-screen');
                this.connectionError = document.getElementById('connection-error');
                this.errorMessage = document.getElementById('error-message');
                this.loadingElement = document.getElementById('loading');
                this.statusOverlay = document.getElementById('status-overlay');
                this.deviceNameElement = document.getElementById('device-name');
                this.currentMediaElement = document.getElementById('current-media');
                this.mediaTimeElement = document.getElementById('media-time');
                this.wsStatusElement = document.getElementById('ws-status');
                this.debugInfo = document.getElementById('debug-info');
                this.debugPanel = document.getElementById('debug-panel');
                this.countdownElement = document.getElementById('countdown');
                this.countdownTimer = document.getElementById('countdown-timer');
                this.deviceMacElement = document.getElementById('device-mac');
                this.deviceStatusElement = document.getElementById('device-status');
                this.authError = document.getElementById('auth-error');
                this.syncNotification = document.getElementById('sync-notification');
                this.generatedAuthCode = document.getElementById('generatedAuthCode');
                this.codeExpiryElement = document.getElementById('codeExpiry');
                
                // Elementos de m√≠dia
                this.mediaDisplay = document.getElementById('media-display');
                this.videoDisplay = document.getElementById('video-display');
                this.youtubeDisplay = document.getElementById('youtube-display');
                this.webDisplay = document.getElementById('web-display');

                this.lastSyncTime = 0;
                this.syncCooldown = 5000;
                this.isProcessingSync = false;
                
                this.init();
            }
            
async init() {
    console.log('üé¨ Iniciando Media Indoor Player...');
    
    // Gerar/recuperar MAC address
    await this.generateDeviceMac();
    
    // Verificar se j√° est√° autenticado
    await this.checkAuthenticationStatus();
    
    // Iniciar gera√ß√£o de c√≥digos
    this.startCodeGeneration();
    
    // INICIAR verifica√ß√£o peri√≥dica de ativa√ß√£o
    this.startActivationPolling();
}

// NOVO: M√©todo para verificar periodicamente se o dispositivo foi ativado
startActivationPolling() {
    console.log('üîÑ Iniciando verifica√ß√£o peri√≥dica de ativa√ß√£o...');
    
    this.activationInterval = setInterval(async () => {
        if (this.deviceId) {
            // J√° est√° autenticado, parar verifica√ß√£o
            clearInterval(this.activationInterval);
            return;
        }
        
        try {
            // Verificar se este MAC foi ativado
            const response = await fetch(`${this.serverUrl}/api/client/check-activation`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mac: this.deviceMac
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.activated && result.device) {
                    console.log('üéâ Dispositivo foi ativado!', result.device);
                    this.deviceId = result.device.id;
                    this.deviceInfo = result.device;
                    
                    // Salvar autentica√ß√£o
                    localStorage.setItem('deviceAuth', JSON.stringify({
                        deviceId: this.deviceId,
                        mac: this.deviceMac,
                        activatedAt: new Date()
                    }));
                    
                    // Parar gera√ß√£o de c√≥digos
                    if (this.codeGenerationInterval) {
                        clearInterval(this.codeGenerationInterval);
                        this.codeGenerationInterval = null;
                    }
                    
                    // Iniciar playback
                    this.startPlayback();
                }
            }
        } catch (error) {
            console.log('Verifica√ß√£o de ativa√ß√£o:', error.message);
        }
    }, 5000); // Verificar a cada 5 segundos
}

            // Gerar MAC address √∫nico para o dispositivo
            async generateDeviceMac() {
                // Tentar recuperar MAC salvo
                let savedMac = localStorage.getItem('deviceMac');
                
                if (!savedMac) {
                    // Gerar novo MAC (formato: XX:XX:XX:XX:XX:XX)
                    const macArray = new Uint8Array(6);
                    crypto.getRandomValues(macArray);
                    savedMac = Array.from(macArray)
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join(':')
                        .toUpperCase();
                    localStorage.setItem('deviceMac', savedMac);
                }
                
                this.deviceMac = savedMac;
                this.deviceMacElement.textContent = this.deviceMac;
                console.log(`üì± MAC do dispositivo: ${this.deviceMac}`);
            }

// No m√©todo checkAuthenticationStatus - CORRIGIDO
async checkAuthenticationStatus() {
    try {
        // Verificar se j√° est√° autenticado pelo localStorage
        const savedAuth = localStorage.getItem('deviceAuth');
        if (savedAuth) {
            const authData = JSON.parse(savedAuth);
            this.deviceId = authData.deviceId;
            
            console.log('üîç Verificando autentica√ß√£o salva:', authData);
            
            // Tentar carregar informa√ß√µes do dispositivo
            try {
                // ADICIONAR MAC no header para autoriza√ß√£o
                const response = await fetch(`${this.serverUrl}/api/client/device`, {
                    headers: {
                        'x-device-mac': this.deviceMac
                    }
                });
                
                if (response.ok) {
                    this.deviceInfo = await response.json();
                    console.log('‚úÖ Dispositivo j√° autenticado e ativo:', this.deviceInfo);
                    this.startPlayback();
                    return;
                } else if (response.status === 403) {
                    console.log('‚ùå Autentica√ß√£o salva n√£o √© mais v√°lida');
                    // Limpar autentica√ß√£o salva se n√£o for mais v√°lida
                    localStorage.removeItem('deviceAuth');
                }
            } catch (error) {
                console.error('Erro ao verificar dispositivo:', error);
            }
        }
        
        // Se n√£o est√° autenticado, mostrar tela de c√≥digo
        this.showAuthScreen();
        
    } catch (error) {
        console.error('‚ùå Erro ao verificar autentica√ß√£o:', error);
        this.showAuthScreen();
    }
}

            // Iniciar gera√ß√£o de c√≥digos
            startCodeGeneration() {
                // Gerar primeiro c√≥digo imediatamente
                this.generateNewAuthCode();
                
                // Gerar novo c√≥digo a cada 5 minutos
                this.codeGenerationInterval = setInterval(() => {
                    this.generateNewAuthCode();
                }, 5 * 60 * 1000); // 5 minutos
            }

            // Gerar novo c√≥digo de autentica√ß√£o
            generateNewAuthCode() {
                // Gerar c√≥digo de 6 d√≠gitos
                this.authCode = Math.floor(100000 + Math.random() * 900000).toString();
                this.codeExpiry = new Date(Date.now() + 5 * 60 * 1000); // 5 minutos
                
                // Atualizar interface
                this.generatedAuthCode.textContent = this.authCode;
                this.updateCodeExpiryDisplay();
                
                console.log(`üîê Novo c√≥digo gerado: ${this.authCode} (V√°lido at√©: ${this.codeExpiry.toLocaleTimeString()})`);
                
                // Enviar c√≥digo para o servidor
                this.registerAuthCodeWithServer();
            }

            // Atualizar display de expira√ß√£o do c√≥digo
            updateCodeExpiryDisplay() {
                const now = new Date();
                const timeLeft = this.codeExpiry - now;
                
                if (timeLeft <= 0) {
                    this.codeExpiryElement.textContent = 'C√≥digo expirado - gerando novo...';
                    return;
                }
                
                const minutes = Math.floor(timeLeft / (60 * 1000));
                const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
                
                this.codeExpiryElement.textContent = `Expira em: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Atualizar a cada segundo
                setTimeout(() => this.updateCodeExpiryDisplay(), 1000);
            }

            // Registrar c√≥digo no servidor
// MODIFICAR: No m√©todo registerAuthCodeWithServer, garantir que o MAC est√° sendo enviado
async registerAuthCodeWithServer() {
    try {
        const response = await fetch(`${this.serverUrl}/api/devices/register-code`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mac: this.deviceMac,
                authCode: this.authCode,
                expiry: this.codeExpiry.toISOString()
            })
        });

        if (response.ok) {
            console.log('‚úÖ C√≥digo registrado no servidor para MAC:', this.deviceMac);
        } else {
            console.error('‚ùå Erro ao registrar c√≥digo no servidor');
        }
    } catch (error) {
        console.error('‚ùå Erro de conex√£o ao registrar c√≥digo:', error);
    }
}

            // Conectar WebSocket
            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                console.log(`üîó Conectando WebSocket: ${wsUrl}`);
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('‚úÖ WebSocket conectado com sucesso');
                    this.reconnectAttempts = 0;
                    this.wsStatusElement.textContent = 'Conectado';
                    this.wsStatusElement.style.color = '#27ae60';
                    
                    // Registrar dispositivo
                    if (this.deviceId) {
                        this.ws.send(JSON.stringify({
                            type: 'register',
                            deviceId: this.deviceId,
                            mac: this.deviceMac,
                            timestamp: Date.now()
                        }));
                    }
                    
                    // Heartbeat
                    setInterval(() => {
                        if (this.ws.readyState === WebSocket.OPEN && this.deviceId) {
                            this.ws.send(JSON.stringify({
                                type: 'ping',
                                deviceId: this.deviceId,
                                timestamp: Date.now()
                            }));
                        }
                    }, 25000);
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üì® Mensagem WebSocket recebida:', data.type);
                        this.handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('‚ùå Erro ao processar mensagem WebSocket:', error);
                    }
                };
                
                this.ws.onclose = (event) => {
                    console.log(`üîå WebSocket desconectado: C√≥digo ${event.code}, Raz√£o: ${event.reason}`);
                    this.wsStatusElement.textContent = 'Desconectado';
                    this.wsStatusElement.style.color = '#e74c3c';
                    
                    const reconnectDelay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
                    setTimeout(() => {
                        this.reconnectAttempts++;
                        this.connectWebSocket();
                    }, reconnectDelay);
                };
                
                this.ws.onerror = (error) => {
                    console.error('‚ùå Erro WebSocket:', error);
                    this.wsStatusElement.textContent = 'Erro';
                    this.wsStatusElement.style.color = '#e74c3c';
                };
            }

            // Restante das fun√ß√µes permanecem as mesmas...
            handleWebSocketMessage(data) {
                console.log('üì® Mensagem WebSocket:', data.type, data);
                
                switch(data.type) {
                    case 'sync_command':
                        console.log('üîÑüîÑüîÑ COMANDO DE SINCRONIZA√á√ÉO RECEBIDO üîÑüîÑüîÑ', data);
                        this.handleSyncCommand(data);
                        break;
                    case 'announcement':
                        console.log('üì¢ Pronunciamento recebido:', data);
                        this.handleAnnouncement(data);
                        break;
                    case 'announcement_cancelled':
                        console.log('‚ùå Pronunciamento cancelado:', data);
                        this.handleAnnouncementCancelled(data);
                        break;
                    case 'send_preview':
                        console.log('üì∏ Preview solicitado');
                        this.sendCurrentMedia();
                        break;
                }
            }

            handleSyncCommand(data) {
                const now = Date.now();
                
                if (this.isProcessingSync || (now - this.lastSyncTime < this.syncCooldown)) {
                    console.log('‚è∏Ô∏è  Sync ignorada - muito recente ou j√° em processamento');
                    return;
                }
                
                console.log('üîÑüîÑüîÑ COMANDO DE SINCRONIZA√á√ÉO RECEBIDO üîÑüîÑüîÑ', data);
                
                this.isProcessingSync = true;
                this.lastSyncTime = now;
                
                this.clearTimers();
                this.stopAllMedia();
                
                this.syncData = {
                    currentMediaIndex: data.currentMediaIndex || 0,
                    mediaStartTime: new Date(data.mediaStartTime),
                    syncTime: new Date(data.syncTime),
                    totalPlaylistDuration: data.totalPlaylistDuration,
                    currentMediaDuration: data.currentMediaDuration,
                    remainingTime: data.remainingTime,
                    elapsedPlaylistTime: data.elapsedPlaylistTime,
                    serverTime: data.serverTime
                };
                
                console.log('üéØ Aplicando sincroniza√ß√£o IMEDIATA:', this.syncData);
                
                this.applySync();
                
                setTimeout(() => {
                    this.isProcessingSync = false;
                }, 1000);
            }

            applySync() {
                console.log('üéØ Aplicando sincroniza√ß√£o completa:', this.syncData);
                
                this.clearTimers();
                this.stopAllMedia();
                
                this.currentMediaIndex = this.syncData.currentMediaIndex || 0;
                this.mediaStartTime = new Date(this.syncData.mediaStartTime);
                this.syncTime = new Date(this.syncData.syncTime);
                this.totalPlaylistDuration = this.syncData.totalPlaylistDuration || 0;
                
                const now = Date.now();
                const serverTime = this.syncData.serverTime || now;
                const clientTime = now;
                
                const networkLatency = clientTime - serverTime;
                console.log(`üì° Lat√™ncia de rede: ${networkLatency}ms`);
                
                const adjustedNow = now - networkLatency;
                const elapsedSinceSync = adjustedNow - this.syncTime.getTime();
                
                console.log(`‚è∞ Tempo desde sincroniza√ß√£o (ajustado): ${elapsedSinceSync}ms`);
                
                let remainingTime = this.syncData.remainingTime || 0;
                let currentMediaDuration = this.syncData.currentMediaDuration || 0;
                
                if (elapsedSinceSync > 0 && currentMediaDuration > 0) {
                    remainingTime = Math.max(0, currentMediaDuration - elapsedSinceSync);
                    console.log(`‚è±Ô∏è Tempo restante ajustado: ${remainingTime}ms (${elapsedSinceSync}ms decorridos)`);
                }
                
                console.log(`üìä Sincroniza√ß√£o OTIMIZADA: M√≠dia ${this.currentMediaIndex}, ${remainingTime}ms restantes, Dura√ß√£o: ${currentMediaDuration}ms`);
                
                if (this.mediaList.length > 0 && this.currentMediaIndex < this.mediaList.length) {
                    const media = this.mediaList[this.currentMediaIndex];
                    this.playMediaWithExactSync(media, remainingTime, currentMediaDuration);
                } else {
                    console.log('‚ùå √çndice de m√≠dia inv√°lido, reiniciando...');
                    this.currentMediaIndex = 0;
                    this.playNextMedia();
                }
                
                this.isSyncing = false;
            }

            playMediaWithExactSync(media, remainingTime, mediaDuration) {
                this.currentMedia = media;
                this.stopAllMedia();
                
                const remainingSeconds = Math.round(remainingTime / 1000);
                const totalSeconds = Math.round(mediaDuration / 1000);
                
                this.currentMediaElement.textContent = media.originalName;
                this.mediaTimeElement.textContent = `${remainingSeconds}s/${totalSeconds}s`;
                this.debugInfo.textContent = `Sincronizado: ${media.originalName} (${remainingSeconds}s)`;
                
                console.log(`üé¨ Reproduzindo m√≠dia sincronizada: ${media.originalName}, ${remainingSeconds}s restantes de ${totalSeconds}s totais`);
                
                this.currentTimeout = setTimeout(() => {
                    console.log('‚è∞ Timer da m√≠dia atual finalizado, indo para pr√≥xima...');
                    this.playNextMedia();
                }, remainingTime);
                
                this.startCountdown(remainingTime);
                
                this.sendCurrentMedia();
                
                this.playMediaByType(media, mediaDuration - remainingTime);
            }

            showAuthScreen() {
                console.log('üéØ Mostrando tela de autentica√ß√£o...');
                this.authScreen.classList.remove('hidden');
                this.connectionError.classList.add('hidden');
                this.statusOverlay.classList.add('hidden');
                this.deviceStatusElement.textContent = 'Aguardando autentica√ß√£o';
                this.hideLoading();
            }

            hideAuthScreen() {
                console.log('üéØ Ocultando tela de autentica√ß√£o...');
                this.authScreen.classList.add('hidden');
                this.authError.style.display = 'none';
                this.hideLoading();
                
                // Parar gera√ß√£o de c√≥digos quando autenticado
                if (this.codeGenerationInterval) {
                    clearInterval(this.codeGenerationInterval);
                    this.codeGenerationInterval = null;
                }
            }

// MODIFICAR: No m√©todo startPlayback, garantir que todas as inicializa√ß√µes acontecem
async startPlayback() {
    console.log('üöÄ Iniciando playback para dispositivo:', this.deviceInfo);
    
    this.hideAuthScreen();
    this.connectionError.classList.add('hidden');
    this.statusOverlay.classList.remove('hidden');
    this.debugPanel.classList.remove('hidden');
    
    this.deviceNameElement.textContent = this.deviceInfo.name;
    this.debugInfo.textContent = `Conectado: ${this.deviceInfo.name}`;
    this.deviceStatusElement.textContent = 'Autenticado';
    
    // PARAR toda verifica√ß√£o de ativa√ß√£o
    if (this.activationInterval) {
        clearInterval(this.activationInterval);
        this.activationInterval = null;
    }
    
    // PARAR gera√ß√£o de c√≥digos
    if (this.codeGenerationInterval) {
        clearInterval(this.codeGenerationInterval);
        this.codeGenerationInterval = null;
    }
    
    this.mediaStartTime = new Date();
    
    await this.loadMediaList();
    this.connectWebSocket();
}

            // ... (outras fun√ß√µes permanecem as mesmas)

            showErrorScreen(message) {
                console.log('‚ùå Mostrando tela de erro:', message);
                this.errorMessage.textContent = message;
                this.connectionError.classList.remove('hidden');
                this.statusOverlay.classList.add('hidden');
                this.authScreen.classList.add('hidden');
                this.hideLoading();
                this.clearTimers();
                this.stopAllMedia();
            }

            // Fun√ß√µes de m√≠dia (permanecem as mesmas)
            playMediaByType(media, remainingTimeMs) {
                const totalDuration = (media.displayTime || 10) * 1000;
                const elapsedTime = totalDuration - remainingTimeMs;
                
                switch(media.mediaType) {
                    case 'upload':
                        if (media.type === 'image') {
                            this.playUploadedImage(media);
                        } else {
                            this.playUploadedVideo(media, elapsedTime);
                        }
                        break;
                    case 'youtube':
                        this.playYouTube(media, elapsedTime);
                        break;
                    case 'website':
                        this.playWebsite(media);
                        break;
                    default:
                        console.warn('Tipo de m√≠dia n√£o suportado:', media.mediaType);
                        setTimeout(() => this.playNextMedia(), 2000);
                }
            }

            playUploadedImage(media) {
                this.showLoading(`Carregando imagem: ${media.originalName}`);
                
                this.mediaDisplay.onload = () => {
                    console.log('‚úÖ Imagem carregada');
                    this.hideLoading();
                    this.mediaDisplay.classList.remove('hidden');
                };
                
                this.mediaDisplay.onerror = () => {
                    console.error('‚ùå Erro ao carregar imagem');
                    this.hideLoading();
                    setTimeout(() => this.playNextMedia(), 2000);
                };
                
                this.mediaDisplay.src = `${this.serverUrl}${media.path}?t=${Date.now()}`;
            }

            playUploadedVideo(media, seekTime = 0) {
                this.showLoading(`Carregando v√≠deo: ${media.originalName}`);
                
                this.videoDisplay.onloadeddata = () => {
                    console.log('‚úÖ V√≠deo carregado');
                    this.hideLoading();
                    this.videoDisplay.classList.remove('hidden');
                    
                    if (seekTime > 0) {
                        const seekSeconds = seekTime / 1000;
                        this.videoDisplay.currentTime = Math.min(seekSeconds, this.videoDisplay.duration - 1);
                        console.log(`‚è© Video seek para: ${seekSeconds}s`);
                    }
                    
                    this.videoDisplay.play().catch(e => {
                        console.error('Erro ao reproduzir v√≠deo:', e);
                        setTimeout(() => this.playNextMedia(), 2000);
                    });
                };
                
                this.videoDisplay.onerror = () => {
                    console.error('‚ùå Erro ao carregar v√≠deo');
                    this.hideLoading();
                    setTimeout(() => this.playNextMedia(), 2000);
                };
                
                this.videoDisplay.onended = () => {
                    console.log('‚è≠Ô∏è V√≠deo finalizado');
                    this.playNextMedia();
                };
                
                this.videoDisplay.src = `${this.serverUrl}${media.path}?t=${Date.now()}`;
            }

            playYouTube(media, seekTime = 0) {
                this.showLoading(`Carregando YouTube: ${media.originalName}`);
                
                const videoId = this.extractYouTubeId(media.path);
                if (!videoId) {
                    console.error('‚ùå URL do YouTube inv√°lida');
                    this.hideLoading();
                    setTimeout(() => this.playNextMedia(), 2000);
                    return;
                }
                
                let startParam = '';
                if (seekTime > 0) {
                    const startSeconds = Math.floor(seekTime / 1000);
                    startParam = `&start=${startSeconds}`;
                    console.log(`‚è© YouTube start em: ${startSeconds}s`);
                }
                
                const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&enablejsapi=1${startParam}`;
                
                this.youtubeDisplay.onload = () => {
                    console.log('‚úÖ YouTube carregado');
                    this.hideLoading();
                    this.youtubeDisplay.classList.remove('hidden');
                };
                
                this.youtubeDisplay.onerror = () => {
                    console.error('‚ùå Erro ao carregar YouTube');
                    this.hideLoading();
                    setTimeout(() => this.playNextMedia(), 2000);
                };
                
                this.youtubeDisplay.src = embedUrl;
            }

            playWebsite(media) {
                this.showLoading(`Carregando site: ${media.originalName}`);
                
                this.webDisplay.onload = () => {
                    console.log('‚úÖ Site carregado');
                    this.hideLoading();
                    this.webDisplay.classList.remove('hidden');
                };
                
                this.webDisplay.onerror = () => {
                    console.error('‚ùå Erro ao carregar site');
                    this.hideLoading();
                    setTimeout(() => this.playNextMedia(), 2000);
                };
                
                this.webDisplay.src = media.path;
            }

            stopAllMedia() {
                this.mediaDisplay.classList.add('hidden');
                this.videoDisplay.classList.add('hidden');
                this.youtubeDisplay.classList.add('hidden');
                this.webDisplay.classList.add('hidden');
                
                this.videoDisplay.pause();
                this.videoDisplay.currentTime = 0;
            }

            clearTimers() {
                if (this.currentTimeout) {
                    clearTimeout(this.currentTimeout);
                    this.currentTimeout = null;
                }
                
                if (this.currentCountdown) {
                    clearInterval(this.currentCountdown);
                    this.currentCountdown = null;
                }
                
                this.countdownElement.classList.add('hidden');
            }

            extractYouTubeId(url) {
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }

            startCountdown(duration) {
                this.countdownElement.classList.remove('hidden');
                let timeLeft = duration / 1000;
                this.countdownTimer.textContent = Math.round(timeLeft);
                
                this.currentCountdown = setInterval(() => {
                    timeLeft--;
                    this.countdownTimer.textContent = Math.round(timeLeft);
                    
                    if (timeLeft <= 0) {
                        clearInterval(this.currentCountdown);
                        this.countdownElement.classList.add('hidden');
                    }
                }, 1000);
            }

            showLoading(message) {
                this.loadingElement.textContent = message;
                this.loadingElement.classList.remove('hidden');
            }
            
            hideLoading() {
                this.loadingElement.classList.add('hidden');
            }

            sendCurrentMedia() {
                const now = Date.now();
                if (now - (this.lastMediaUpdate || 0) < 10000) {
                    return;
                }
                
                if (this.ws && this.ws.readyState === WebSocket.OPEN && this.currentMedia) {
                    const mediaDuration = (this.currentMedia.displayTime || 10) * 1000;
                    
                    let elapsed = 0;
                    let remainingTime = mediaDuration;
                    
                    if (this.mediaStartTime) {
                        elapsed = now - this.mediaStartTime.getTime();
                        remainingTime = Math.max(0, mediaDuration - elapsed);
                    }
                    
                    const mediaInfo = {
                        type: 'current_media',
                        deviceId: this.deviceId,
                        media: this.currentMedia,
                        currentMediaIndex: this.currentMediaIndex,
                        mediaStartTime: this.mediaStartTime ? this.mediaStartTime.toISOString() : new Date().toISOString(),
                        syncTime: this.syncTime ? this.syncTime.toISOString() : null,
                        remainingTime: remainingTime,
                        mediaDuration: mediaDuration,
                        elapsed: elapsed,
                        timestamp: new Date()
                    };
                    
                    this.ws.send(JSON.stringify(mediaInfo));
                    this.lastMediaUpdate = now;
                    
                    console.log('üì§ Enviando update de m√≠dia:', {
                        media: this.currentMedia.originalName,
                        remainingTime: Math.round(remainingTime / 1000) + 's'
                    });
                }
            }
// ADICIONAR: M√©todo para carregar m√≠dias com autoriza√ß√£o por MAC
async loadMediaList(forceRestart = false) {
    try {
        this.showLoading('Carregando conte√∫do...');
        
        const response = await fetch(`${this.serverUrl}/api/client/media`, {
            headers: {
                'x-device-mac': this.deviceMac
            }
        });
        
        if (response.ok) {
            const newMediaList = await response.json();
            const mediaChanged = JSON.stringify(newMediaList) !== JSON.stringify(this.mediaList);
            
            this.mediaList = newMediaList;
            console.log(`üìã ${this.mediaList.length} m√≠dia(s) carregada(s)`);
            
            if (this.mediaList.length > 0) {
                this.hideLoading();
                
                if (forceRestart || mediaChanged || this.currentMediaIndex >= this.mediaList.length) {
                    this.currentMediaIndex = 0;
                    this.mediaStartTime = new Date();
                    this.playNextMedia();
                } else if (!this.isSyncing) {
                    this.playNextMedia();
                }
            } else {
                this.showLoading('‚ö†Ô∏è Nenhum conte√∫do dispon√≠vel');
            }
        } else {
            throw new Error('Erro ao carregar conte√∫do');
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar m√≠dias:', error);
        this.showErrorScreen('Erro ao carregar conte√∫do');
    }
}

            playNextMedia() {
                if (this.mediaList.length === 0) {
                    console.log('‚ùå Nenhuma m√≠dia para reproduzir');
                    return;
                }
                
                this.clearTimers();
                
                if (this.currentMediaIndex >= this.mediaList.length) {
                    this.currentMediaIndex = 0;
                    console.log('üîÑ Fim da playlist, reiniciando...');
                }
                
                const media = this.mediaList[this.currentMediaIndex];
                const mediaDuration = (media.displayTime || 10) * 1000;
                
                console.log(`üé¨ Reproduzindo m√≠dia ${this.currentMediaIndex + 1}/${this.mediaList.length}: ${media.originalName} por ${mediaDuration}ms`);
                
                if (this.syncTime) {
                    const now = Date.now();
                    const syncElapsed = now - this.syncTime.getTime();
                    const playlistPosition = syncElapsed % this.totalPlaylistDuration;
                    
                    this.recalculateMediaIndexFromSync(playlistPosition);
                    
                    const mediaStartTime = this.calculateMediaStartTime(this.currentMediaIndex);
                    const mediaElapsed = now - mediaStartTime;
                    const remainingTime = Math.max(0, mediaDuration - mediaElapsed);
                    
                    console.log(`üîÑ Recalculando sincroniza√ß√£o: Posi√ß√£o ${playlistPosition}ms, M√≠dia ${this.currentMediaIndex}, ${remainingTime}ms restantes`);
                    
                    this.playMediaWithExactSync(media, remainingTime, mediaDuration);
                } else {
                    this.playMedia(media);
                }
                
                this.currentMediaIndex = (this.currentMediaIndex + 1) % this.mediaList.length;
            }

            recalculateMediaIndexFromSync(playlistPosition) {
                let accumulatedTime = 0;
                
                for (let i = 0; i < this.mediaList.length; i++) {
                    const media = this.mediaList[i];
                    const mediaDuration = (media.displayTime || 10) * 1000;
                    
                    if (playlistPosition < accumulatedTime + mediaDuration) {
                        this.currentMediaIndex = i;
                        console.log(`üìä Sincroniza√ß√£o: Posi√ß√£o ${playlistPosition}ms ‚Üí M√≠dia ${i}`);
                        return;
                    }
                    
                    accumulatedTime += mediaDuration;
                }
                
                this.currentMediaIndex = 0;
            }

            calculateMediaStartTime(mediaIndex) {
                if (!this.syncTime) return Date.now();
                
                let accumulatedTime = 0;
                
                for (let i = 0; i < mediaIndex; i++) {
                    const media = this.mediaList[i];
                    accumulatedTime += (media.displayTime || 10) * 1000;
                }
                
                return this.syncTime.getTime() + accumulatedTime;
            }

            playMedia(media, isAnnouncement = false) {
                this.currentMedia = media;
                this.stopAllMedia();
                
                this.currentMediaElement.textContent = media.originalName;
                this.mediaTimeElement.textContent = `${media.displayTime}s`;
                this.debugInfo.textContent = `Reproduzindo: ${media.originalName} ${isAnnouncement ? '(Anunciamento)' : ''}`;
                
                const displayTime = (media.displayTime || 10) * 1000;
                
                this.mediaStartTime = new Date();
                
                this.startCountdown(displayTime);
                
                this.currentTimeout = setTimeout(() => {
                    if (!isAnnouncement) {
                        this.playNextMedia();
                    }
                }, displayTime);
                
                this.sendCurrentMedia();
                
                this.playMediaByType(media, 0);
            }

            handleAnnouncement(data) {
                console.log('üì¢ Anunciamento recebido:', data.announcement.name);
                
                this.clearTimers();
                this.stopAllMedia();
                
                this.playMedia(data.media, true);
                
                setTimeout(() => {
                    this.loadMediaList(true);
                }, data.announcement.displayTime * 1000);
            }
            
            handleAnnouncementCancelled(data) {
                console.log('üõë Anunciamento cancelado');
                this.loadMediaList(true);
            }
            
            showSyncNotification() {
                this.syncNotification.classList.remove('hidden');
                setTimeout(() => {
                    this.syncNotification.classList.add('hidden');
                }, 3000);
            }
        }
        
        let mediaPlayer;
        
        document.addEventListener('DOMContentLoaded', () => {
            mediaPlayer = new MediaPlayer();
        });

        document.addEventListener('dragstart', (e) => e.preventDefault());
        
        window.addEventListener('error', (e) => {
            console.error('üö® Erro global:', e.error);
        });
    </script>
</body>
</html>