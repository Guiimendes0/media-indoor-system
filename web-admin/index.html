<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDIA STAFF - Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Tela de Login -->
    <div id="login-screen">
        <div class="login-container">
                <div class="logo">
                    <img src="https://www.mediastaff.com.br/assets/logo.png" alt="">
                    <h2>MEDIA STAFF</h2>
                </div>
            <p>Sistema de Gerenciamento</p>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="username">Usu√°rio</label>
                    <input type="text" id="username" required placeholder="Digite seu usu√°rio">
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required placeholder="Digite sua senha">
                </div>
                <button type="submit" class="login-btn">Entrar</button>
                <!-- No login-form, ap√≥s o bot√£o de login -->
                <div style="margin-top: 15px; text-align: center;">
                    <button type="button" class="butn btn-link" onclick="openResetPasswordModal()" 
                            style="background: none; border: none; color: #000000; cursor: pointer; ">
                        Esqueci minha senha
                    </button>
                </div>
            </form>
        </div>
    </div>
<!-- Adicionar este modal ap√≥s o modal de login -->
<div id="resetPasswordModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Redefinir Senha</h2>
            <button class="close-btn" onclick="closeModal('resetPasswordModal')">√ó</button>
        </div>
        <form id="resetPasswordForm">
            <div class="form-group">
                <label for="resetUsername">Usu√°rio</label>
                <input type="text" id="resetUsername" class="form-control" required placeholder="Digite seu usu√°rio">
            </div>
            <div class="form-group">
                <label for="resetNewPassword">Nova Senha</label>
                <input type="password" id="resetNewPassword" class="form-control" required placeholder="Digite a nova senha">
            </div>
            <div class="form-group">
                <label for="resetConfirmPassword">Confirmar Nova Senha</label>
                <input type="password" id="resetConfirmPassword" class="form-control" required placeholder="Confirme a nova senha">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button type="submit" class="btn btn-warning">Redefinir Senha</button>
                <button type="button" class="btn btn-danger" onclick="closeModal('resetPasswordModal')">‚ùå Cancelar</button>
            </div>
        </form>
    </div>
</div>
    <!-- Sistema Principal -->
    <div class="container hidden" id="main-system">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="https://www.mediastaff.com.br/assets/logo.png" alt="">
                    <h2>MEDIA STAFF</h2>
                </div>
                <p>Sistema de Gerenciamento</p>
            </div>
            
            <div class="user-info">
                <strong id="user-name">Usu√°rio</strong>
                <span id="user-role">Fun√ß√£o</span>
            </div>
            
            <ul class="sidebar-menu">
                <li class="active" data-tab="dashboard"><i class="ti ti-chart-column"></i> Dashboard</li>
                <li data-tab="devices"><i class="ti ti-device-desktop"></i> Dispositivos</li>
                <li data-tab="media"><i class="ti ti-photo-video"></i> M√≠dias</li>
                <li data-tab="campaigns"><i class="ti ti-mountain"></i> Campanha</li>
                <li data-tab="playlists"><i class="ti ti-list"></i> Playlists</li>
                <li data-tab="announcements"><i class="ti ti-speakerphone"></i> Anunciamentos</li>
                <li data-tab="integrations"><i class="ti ti-circles-relation"></i> Integra√ß√µes</li>
                <li data-tab="users" id="users-tab" class="hidden"><i class="ti ti-users"></i> Usu√°rios</li>
                <li data-tab="backup"><i class="ti ti-database-export"></i> Backup</li>
            </ul>
            <div class="mobile-menu">
                <i class="ti ti-menu-2"></i>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Header com a√ß√µes -->
            <div class="header">
                <h1 id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="butn refresh-btn" onclick="loadAllData()">
                        <i class="ti ti-refresh"></i>
                    </button>
                    <button class="butn logout-btn" onclick="logout()">
                        <i class="ti ti-logout"></i>
                    </button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Dispositivos</h3>
                        <div class="number" id="statDevices">0</div>
                        <div id="statDevicesOnline">0 ativos</div>
                    </div>
                    <div class="stat-card">
                        <h3>M√≠dias</h3>
                        <div class="number" id="statMedia">0</div>
                        <div id="statMediaTypes">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Playlists</h3>
                        <div class="number" id="statPlaylists">0</div>
                        <div id="statPlaylistsActive">- ativas</div>
                    </div>
                    <!-- <div class="stat-card">
                        <h3>Sistema</h3>
                        <div class="number">üü¢</div>
                        <div>Online</div>
                    </div> -->
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Dispositivos Conectados</h2>
                    </div>
                    <table class="table" id="devicesTable">
                        <thead>
                            <tr>
                                <th id="tNome">Nome</th>
                                <th id="tLocation">Localiza√ß√£o</th>
                                <th id="tStatus">Status</th>
                                <th id="tLastSeen">√öltima Atividade</th>
                                <th id="tPlaylist">Playlist</th>
                                <!-- <th id="tActionButtons">A√ß√µes</th> -->
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Dispositivos -->
            <div id="devices" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Gerenciar Dispositivos</h2>
                        <button class="butn btn-primary" id="addDeviceBtn">
                            <i class="ti ti-plus"></i> Adicionar
                        </button>
                    </div>
                    <table class="table" id="devicesListTable">
                        <thead>
                            <tr>
                                <th id="tNome">Nome</th>
                                <th id="tLocation">Localiza√ß√£o</th>
                                <th id="tStatus">Status</th>
                                <th id="tCode">C√≥digo Auth</th>
                                <th id="tPlaylist">Playlist</th>
                                <th id="tLastSeen">√öltima Atividade</th>
                                <th id="tActionButtons">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Configura√ß√£o do Dispositivo -->
            <div id="device-config" class="tab-content">
                <button class="back-button" onclick="showDevicesList()">
                    <i class="ti ti-arrow-left"></i> Voltar para Lista
                </button>
                
                <div class="card">
                    <div class="card-header">
                        <h2 id="device-config-title">Configura√ß√£o do Dispositivo</h2>
                    </div>
                    
                    <div class="device-config-layout">
                        <!-- Preview da Tela -->
                        <div class="device-screen-preview">
                            <div class="device-screen-content" id="deviceScreenContent">
                                <div class="current-media-info">
                                    <div class="current-media-name" id="currentMediaName">Nenhuma m√≠dia em reprodu√ß√£o</div>
                                    <div class="current-media-time" id="currentMediaTime">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Formul√°rio de Configura√ß√£o -->
                        <div class="device-config-form">
                            <div class="config-section">
                                <h3>Informa√ß√µes do Dispositivo</h3>
                                <div class="form-group">
                                    <label for="configDeviceName">Nome do Dispositivo</label>
                                    <input type="text" id="configDeviceName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="configDeviceLocation">Localiza√ß√£o</label>
                                    <input type="text" id="configDeviceLocation" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="configDevicePlaylist">Playlist</label>
                                    <select id="configDevicePlaylist" class="form-control">
                                        <option value="">Todas as m√≠dias</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>MAC Address</label>
                                    <div class="form-control" style="background: #f8f9fa; font-family: monospace;" id="configDeviceMac">
                                        -
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <div class="form-control" style="background: #f8f9fa;" id="configDeviceStatus">
                                        -
                                    </div>
                                </div>
                            </div>
                            
                            <div class="config-section">
                                <h3>Configura√ß√µes de √Åudio</h3>
                                <div class="toggle-label">
                                    <span>√Åudio Habilitado</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="configDeviceAudio">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                    Quando habilitado, o dispositivo reproduzir√° m√≠dias com √°udio. 
                                    Por padr√£o, o √°udio √© desabilitado.
                                </p>
                            </div>

                            <div class="config-section">
                                <h3>Configura√ß√µes de Desenvolvedor</h3>
                                <div class="toggle-label">
                                    <span>Modo Desenvolvedo</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="configDeviceDeveloper">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                    Quando habilitado, o dispositivo ter√° varias informa√ß√µes na tela para depura√ß√£o. 
                                    Por padr√£o, o modo developer √© desabilitado.
                                </p>
                            </div>
                            
                            <div class="config-section">
                                <h3>Orienta√ß√£o da Tela</h3>
                                <div class="rotation-options">
                                    <div class="rotation-option" data-rotation="horizontal" onclick="selectRotation('horizontal')">
                                        <i class="ti ti-device-desktop"></i>
                                        <span>Horizontal</span>
                                    </div>
                                    <div class="rotation-option" data-rotation="vertical" onclick="selectRotation('vertical')">
                                        <i class="ti ti-device-mobile"></i>
                                        <span>Vertical</span>
                                    </div>
                                    <div class="rotation-option" data-rotation="horizontal-inverted" onclick="selectRotation('horizontal-inverted')">
                                        <i class="ti ti-device-desktop"></i>
                                        <span>Horizontal Invertido</span>
                                    </div>
                                    <div class="rotation-option" data-rotation="vertical-inverted" onclick="selectRotation('vertical-inverted')">
                                        <i class="ti ti-device-mobile"></i>
                                        <span>Vertical Invertido</span>
                                    </div>
                                </div>
                                <input type="hidden" id="configDeviceRotation" value="horizontal">
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" onclick="saveDeviceConfig()">
                                    <i class="ti ti-device-floppy"></i> Salvar Configura√ß√µes
                                </button>
                                <button class="btn btn-danger" onclick="disconnectConfigDevice()">
                                    <i class="ti ti-device-desktop-x"></i> Desconectar Dispositivo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- M√≠dias -->
            <div id="media" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Gerenciar M√≠dias</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="butn btn-primary" id="addMediaBtn">
                                <i class="ti ti-photo-up"></i>
                            </button>
                            <button class="butn btn-success" id="addExternalMediaBtn">
                                <i class="ti ti-world-upload"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h3>Lista de M√≠dias (Arraste para reordenar)</h3>
                            <div class="media-tabs">
                                <button class="media-tab active" data-type="all">Todas</button>
                                <button class="media-tab" data-type="image">Imagens</button>
                                <button class="media-tab" data-type="video">V√≠deos</button>
                                <button class="media-tab" data-type="external">Externas</button>
                            </div>
                        </div>
                        <div class="media-list" id="mediaList">
                            <!-- Itens ser√£o preenchidos via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campanhas -->
            <div id="campaigns" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Gerenciar Campanhas</h2>
                        <button class="butn btn-primary" id="addCampaignBtn">
                            <i class="ti ti-plus"></i> Criar Campanha
                        </button>
                    </div>
                    <div id="campaignsList"></div>
                </div>
            </div>

            <!-- Playlists -->
            <div id="playlists" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Gerenciar Playlists</h2>
                        <div style="display: flex;gap: 10px;"">
                            <button class="butn btn-success" onclick="syncAllPlaylists()">
                                Sincronizar Todas
                            </button>
                            <button class="butn btn-primary" id="addPlaylistBtn">
                                Criar Playlist
                            </button>
                        </div>
                    </div>
                    <div id="playlistsList"></div>
                </div>
            </div>

            <!-- Anunciamentos -->
            <div id="announcements" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Anunciamentos Gerais</h2>
                        <button class="btn btn-warning" id="addAnnouncementBtn">
                            Criar Anunciamento
                        </button>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h3>Anunciamentos Ativos</h3>
                        </div>
                        <div id="announcementsList">
                            <!-- Anunciamentos ser√£o preenchidos via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integra√ß√µes -->
            <div id="integrations" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Gerenciar Integra√ß√µes</h2>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Sankhya</h3>
                            <img src="https://play-lh.googleusercontent.com/FSeNTle3VBLxnFmsoaIboQlsr3Lyg5f8urVrqkTvsZvoHg8_hZTqFprRbYmOYPX_C_E" alt="Captura de tela 2025-11-06 081235.png" class="media-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <!-- <div class="number" id="statDevices">0</div> -->
                            <div id="statDevicesOnline">Ativa</div>
                        </div>
                        <div class="stat-card">
                            <h3>FeeGow</h3>
                            <img src="https://media.glassdoor.com/sqll/2866355/feegow-squareLogo-1660071078043.png" alt="Captura de tela 2025-11-06 081235.png" class="media-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <!-- <div class="number" id="statMedia">0</div> -->
                            <div id="statMediaTypes">Ativa</div>
                        </div>
                        <div class="stat-card">
                            <h3>MerCloud</h3>
                            <img src="mercloud.png" alt="Captura de tela 2025-11-06 081235.png" class="media-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <!-- <div class="number" id="statPlaylists">0</div> -->
                            <div id="statPlaylistsActive">N√£o Integrada</div>
                        </div>
                        <div class="stat-card">
                            <h3>SAP</h3>
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-sap-logo-icon-svg-download-png-2945134.png" alt="Captura de tela 2025-11-06 081235.png" class="media-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <!-- <div class="number" id="statPlaylists">0</div> -->
                            <div id="statPlaylistsActive">N√£o Integrada</div>
                        </div>
                        <div class="stat-card">
                            <h3>TOTVS</h3>
                            <img src="https://images.icon-icons.com/2148/PNG/512/totvs_icon_131953.png" alt="Captura de tela 2025-11-06 081235.png" class="media-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <!-- <div class="number" id="statPlaylists">0</div> -->
                            <div id="statPlaylistsActive">N√£o Integrada</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usu√°rios -->
            <div id="users" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Gerenciar Usu√°rios</h2>
                        <button class="btn btn-primary" id="addUserBtn">
                            Adicionar Usu√°rio
                        </button>
                    </div>
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Usu√°rio</th>
                                <th>Fun√ß√£o</th>
                                <th>Criado em</th>
                                <th>√öltimo Login</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Backup -->
            <div id="backup" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Dados do Sistema</h2>
                    <div class="form-group">
                        <label>Exportar Dados</label>
                        <button class="btn btn-primary" id="exportBtn">
                            Exportar Backup
                        </button>
                        <p style="margin-top: 8px; color: #666; font-size: 14px;">
                            Exporta todos os dados para um arquivo JSON
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label>Status do Sistema</label>
                        <div id="systemStatus" style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            Carregando...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Container de Notifica√ß√µes -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmationModal" class="confirmation-modal hidden">
        <div class="confirmation-content">
            <h3 id="confirmationTitle">Confirmar A√ß√£o</h3>
            <p id="confirmationMessage">Tem certeza que deseja realizar esta a√ß√£o?</p>
            <div class="confirmation-buttons">
                <button class="btn btn-danger" id="confirmButton">Confirmar</button>
                <button class="btn btn-primary" id="cancelButton">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Dispositivo -->
    <div id="deviceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="deviceModalTitle">Adicionar Dispositivo</h2>
                <button class="close-btn" onclick="closeModal('deviceModal')"><i class="ti ti-x"></i></button>
            </div>
            <form id="deviceForm">
                <input type="hidden" id="deviceId">
                <div class="form-group">
                    <label for="deviceName">Nome do Dispositivo *</label>
                    <input type="text" id="deviceName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="deviceIp" id="deviceIpLabel">C√≥digo de Ativa√ß√£o *</label>
                    <input type="text" id="deviceIp" class="form-control" required 
                           placeholder="Digite o c√≥digo de 6 d√≠gitos do dispositivo" 
                           pattern="[0-9]{6}" maxlength="6">
                </div>
                <div class="form-group">
                    <label for="deviceLocation">Localiza√ß√£o *</label>
                    <input type="text" id="deviceLocation" class="form-control" required placeholder="Ex: Sala de Reuni√£o">
                </div>
                <div class="form-group">
                    <label for="devicePlaylist">Playlist Espec√≠fica</label>
                    <select id="devicePlaylist" class="form-control">
                        <option value="">Todas as m√≠dias</option>
                    </select>
                </div>

                <div class="device-instructions">
                    <strong>Como adicionar um dispositivo:</strong><br>
                    1. Acesse o dispositivo na TV/Player<br>
                    2. Anote o c√≥digo de 6 d√≠gitos exibido<br>
                    3. Digite o c√≥digo acima<br>
                    4. O dispositivo ser√° identificado automaticamente pelo MAC address
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('deviceModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal M√≠dia Upload -->
    <div id="mediaModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload de M√≠dia</h2>
                <button class="close-btn" onclick="closeModal('mediaModal')">√ó</button>
            </div>
            <form id="mediaForm">
                <div class="upload-area" id="uploadArea">
                    <p>Arraste arquivos aqui ou clique para selecionar</p>
                    <p style="font-size: 0.8rem; color: #777;">
                        Formatos: JPG, PNG, GIF, BMP, MP4, AVI, MOV, MKV, WEBM<br>
                        M√°x: 100MB por arquivo
                    </p>
                    <input type="file" id="fileInput" multiple accept="image/*,video/*" class="hidden">
                </div>
                <div class="form-group">
                    <label for="mediaDisplayTime">Tempo de Exibi√ß√£o (segundos)</label>
                    <input type="number" id="mediaDisplayTime" class="form-control" value="10" min="5" max="300">
                </div>
            </form>
        </div>
    </div>

    <!-- Modal M√≠dia Externa -->
    <div id="externalMediaModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adicionar M√≠dia Externa</h2>
                <button class="close-btn" onclick="closeModal('externalMediaModal')">√ó</button>
            </div>
            <form id="externalMediaForm">
                <div class="form-group">
                    <label for="externalMediaName">Nome da M√≠dia *</label>
                    <input type="text" id="externalMediaName" class="form-control" required placeholder="Ex: V√≠deo Promocional">
                </div>
                <div class="form-group">
                    <label for="externalMediaType">Tipo de M√≠dia *</label>
                    <select id="externalMediaType" class="form-control" required>
                        <option value="">Selecione...</option>
                        <option value="youtube">YouTube</option>
                        <option value="website">Site Web</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="externalMediaUrl">URL *</label>
                    <input type="url" id="externalMediaUrl" class="form-control" required 
                           placeholder="Ex: https://www.youtube.com/watch?v=... ou https://exemplo.com">
                </div>
                <div class="form-group">
                    <label for="externalMediaDisplayTime">Tempo de Exibi√ß√£o (segundos)</label>
                    <input type="number" id="externalMediaDisplayTime" class="form-control" value="30" min="5" max="300">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-success">Adicionar</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('externalMediaModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar M√≠dia -->
    <div id="editMediaModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar M√≠dia</h2>
                <button class="close-btn" onclick="closeModal('editMediaModal')">√ó</button>
            </div>
            <form id="editMediaForm">
                <input type="hidden" id="editMediaId">
                <div class="form-group">
                    <label for="editMediaName">Nome da M√≠dia *</label>
                    <input type="text" id="editMediaName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editMediaDisplayTime">Tempo de Exib√≠cio (segundos) *</label>
                    <input type="number" id="editMediaDisplayTime" class="form-control" required min="5" max="300">
                </div>
                <div class="form-group" id="editMediaUrlGroup">
                    <label for="editMediaUrl">URL *</label>
                    <input type="url" id="editMediaUrl" class="form-control" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('editMediaModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

<!-- Modal Playlist -->
<div id="playlistModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="playlistModalTitle">Criar Playlist</h2>
            <button class="close-btn" onclick="closeModal('playlistModal')">√ó</button>
        </div>
        <form id="playlistForm">
            <input type="hidden" id="playlistId">
            <div class="form-group">
                <label for="playlistName">Nome da Playlist *</label>
                <input type="text" id="playlistName" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Conte√∫do da Playlist (Arraste para ordenar)</label>
                
                <!-- Tabs para escolher entre M√≠dias e Campanhas -->
                <div class="content-tabs">
                    <button type="button" class="content-tab active" data-content="media">M√≠dias Individuais</button>
                    <button type="button" class="content-tab" data-content="campaigns">Campanhas</button>
                </div>
                
                <!-- Container para M√≠dias -->
                <div id="playlistMediaContent" class="playlist-content active">
                    <div class="media-checkboxes" id="mediaCheckboxes">
                        <!-- Checkboxes de m√≠dias individuais -->
                    </div>
                </div>
                
                <!-- Container para Campanhas -->
                <div id="playlistCampaignsContent" class="playlist-content">
                    <div class="campaign-checkboxes" id="campaignCheckboxes">
                        <!-- Checkboxes de campanhas -->
                    </div>
                </div>
                
                <!-- Preview da ordem da playlist -->
                <div class="playlist-order-preview" id="playlistOrderPreview">
                    <h4 style="margin: 15px 0 10px 0;">Ordem da Playlist:</h4>
                    <div id="playlistOrderList"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button type="submit" class="btn btn-success">Salvar</button>
                <button type="button" class="btn btn-danger" onclick="closeModal('playlistModal')">Cancelar</button>
            </div>
        </form>
    </div>
</div>
    <!-- Modal Campanha -->
    <div id="campaignModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="campaignModalTitle">Criar Campanha</h2>
                <button class="close-btn" onclick="closeModal('campaignModal')">√ó</button>
            </div>
            <form id="campaignForm">
                <input type="hidden" id="campaignId">
                <div class="form-group">
                    <label for="campaignName">Nome da Campanha *</label>
                    <input type="text" id="campaignName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>M√≠dias na Campanha (Arraste para ordenar)</label>
                    <div class="media-checkboxes" id="campaignMediaCheckboxes">
                        <!-- Checkboxes ser√£o preenchidos via JavaScript -->
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('campaignModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal Anunciamento -->
    <div id="announcementModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Criar Pronunciamento Geral</h2>
                <button class="close-btn" onclick="closeModal('announcementModal')">√ó</button>
            </div>
            <form id="announcementForm">
                <div class="form-group">
                    <label for="announcementName">Nome do Pronunciamento *</label>
                    <input type="text" id="announcementName" class="form-control" required placeholder="Ex: An√∫ncio Importante">
                </div>
                <div class="form-group">
                    <label for="announcementMedia">M√≠dia para Exibi√ß√£o *</label>
                    <select id="announcementMedia" class="form-control" required>
                        <option value="">Selecione uma m√≠dia...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="announcementDevices">Dispositivos *</label>
                    <div id="announcementDevicesCheckboxes">
                        <!-- Checkboxes ser√£o preenchidos via JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="announcementDisplayTime">Tempo de Exibi√ß√£o (segundos) *</label>
                    <input type="number" id="announcementDisplayTime" class="form-control" value="30" min="5" max="300" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-warning">Iniciar Pronunciamento</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('announcementModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Visualiza√ß√£o de Dispositivo -->
    <div id="devicePreviewModal" class="modal hidden">
        <div class="modal-content device-preview-modal">
            <div class="modal-header">
                <h2 id="devicePreviewTitle">Visualiza√ß√£o do Dispositivo</h2>
                <button class="close-btn" onclick="closeModal('devicePreviewModal')">√ó</button>
            </div>
            <div class="device-preview" id="devicePreview">
                <div class="device-preview-placeholder">
                    <i>üì±</i>
                    <p>Conectando ao dispositivo...</p>
                    <p style="font-size: 12px; color: #ccc;" id="devicePreviewInfo"></p>
                </div>
            </div>
            <div class="form-group">
                <label>Status do Dispositivo</label>
                <div id="devicePreviewStatus" style="padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    Aguardando dados do dispositivo...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Usu√°rio -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Adicionar Usu√°rio</h2>
                <button class="close-btn" onclick="closeModal('userModal')">√ó</button>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label for="userName">Nome Completo *</label>
                    <input type="text" id="userName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userUsername">Usu√°rio *</label>
                    <input type="text" id="userUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Senha *</label>
                    <input type="password" id="userPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Fun√ß√£o *</label>
                    <select id="userRole" class="form-control" required>
                        <option value="user">Usu√°rio</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('userModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

 <script>
    // Vari√°veis globais
    const SERVER_URL = window.location.origin;
    let currentUser = null;
    let authToken = null;
    let currentDevices = [];
    let currentMedia = [];
    let currentCampaigns = [];
    let editingCampaignId = null;
    let currentPlaylists = [];
    let currentUsers = [];
    let currentAnnouncements = [];
    let editingDeviceId = null;
    let editingPlaylistId = null;
    let ws = null;
    let devicePreviewInterval = null;

    let lastSyncClick = 0;
    const SYNC_COOLDOWN = 3000; // 3 segundos

    // NOVO: Controle de event listeners j√° adicionados
    let eventListenersAdded = false;
    let syncButtonsInitialized = false;

    // NOVO: Dispositivo atualmente em configura√ß√£o
    let currentConfigDevice = null;

    // Sistema de notifica√ß√µes
    function showNotification(message, type = 'success', duration = 5000) {
        const container = document.getElementById('notificationContainer');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        notification.innerHTML = `
            <span>${message}</span>
            <button class="close-notification" onclick="this.parentElement.remove()">√ó</button>
        `;
        
        container.appendChild(notification);
        
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, duration);
        }
        
        return notification;
    }

    // Sistema de confirma√ß√£o
    function showConfirmation(message, title = 'Confirmar A√ß√£o') {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirmationModal');
            const titleEl = document.getElementById('confirmationTitle');
            const messageEl = document.getElementById('confirmationMessage');
            const confirmBtn = document.getElementById('confirmButton');
            const cancelBtn = document.getElementById('cancelButton');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            modal.classList.remove('hidden');
            
            const cleanup = () => {
                modal.classList.add('hidden');
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
            };
            
            confirmBtn.onclick = () => {
                cleanup();
                resolve(true);
            };
            
            cancelBtn.onclick = () => {
                cleanup();
                resolve(false);
            };
        });
    }

    // WebSocket para funcionalidades em tempo real
    function connectWebSocket() {

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;

        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('üîó WebSocket conectado');
                showNotification('Conectado em tempo real', 'success', 3000);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Erro ao processar mensagem WebSocket:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('üîå WebSocket desconectado');
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = (error) => {
                console.error('‚ùå Erro WebSocket:', error);
            };
        } catch (error) {
            console.error('‚ùå Erro ao conectar WebSocket:', error);
        }
    }

    function handleWebSocketMessage(data) {
        switch (data.type) {
            case 'device_media_update':
                updateDevicePreview(data);
                // NOVO: Atualizar informa√ß√µes da m√≠dia atual na tela de configura√ß√£o
                if (currentConfigDevice && data.deviceId === currentConfigDevice.id) {
                    updateCurrentMediaInfo(data);
                }
                break;
            case 'sync_command':
                showNotification(`Comando de sincroniza√ß√£o recebido: ${data.command}`, 'info');
                break;
            case 'announcement':
                showNotification(`Pronunciamento iniciado: ${data.announcement.name}`, 'warning');
                break;
        }
    }

    // NOVO: Atualizar informa√ß√µes da m√≠dia atual
    function updateCurrentMediaInfo(data) {
        document.getElementById('currentMediaName').textContent = data.media.originalName;
        
        const displayTime = data.media.displayTime || 10;
        document.getElementById('currentMediaTime').textContent = `${displayTime}s`;
    }

    // Sistema de autentica√ß√£o
    async function login(username, password) {
        try {
            const response = await fetch(`${SERVER_URL}/api/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                authToken = data.token;
                currentUser = data.user;
                
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('userData', JSON.stringify(currentUser));
                
                showMainSystem();
                connectWebSocket();
                showNotification('Login realizado com sucesso!');
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Logout
    async function logout() {
        try {
            await authenticatedFetch(`${SERVER_URL}/api/auth/logout`, {
                method: 'POST'
            });
        } catch (error) {
            // Ignorar erros no logout (pode ser que a sess√£o j√° esteja expirada)
            console.log('Logout:', error.message);
        } finally {
            // Sempre limpar os dados locais
            if (ws) ws.close();
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            
            showLoginScreen();
        }
    }
            //  Fun√ß√£o para carregar dados espec√≠ficos de cada aba
function loadTabSpecificData(tab) {
    switch(tab) {
        case 'dashboard':
            loadDevices();
            updateStats();
            updateDevicesTable();
            break;
        case 'devices':
            loadDevices();
            break;
        case 'media':
            loadMedia();
            break;
        case 'playlists':
            loadPlaylists();
            loadCampaigns(); // Para mostrar campanhas dispon√≠veis
            break;
        case 'campaigns':
            loadCampaigns();
            loadMedia(); // Para mostrar m√≠dias dispon√≠veis
            break;
        case 'announcements':
            loadAnnouncements();
            loadMedia();
            loadDevices();
            break;
        case 'users':
            if (currentUser.role === 'admin') {
                loadUsers();
            }
            break;
        case 'backup':
            updateSystemStatus();
            break;
    }
}
    function showLoginScreen() {
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-system').classList.add('hidden');
    }

    function showMainSystem() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-system').classList.remove('hidden');
        
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usu√°rio';
        
        if (currentUser.role === 'admin') {
            document.getElementById('users-tab').classList.remove('hidden');
        } else {
            document.getElementById('users-tab').classList.add('hidden');
        }
        
        loadAllData().then(() => {
        // E depois carregar dados espec√≠ficos da aba atual (Dashboard)
        loadTabSpecificData('dashboard');
    });
    }

// ATUALIZADA: Verificar autentica√ß√£o
function checkAuthentication() {
    const savedToken = localStorage.getItem('authToken');
    const savedUser = localStorage.getItem('userData');
    
    if (savedToken && savedUser) {
        try {
            authToken = savedToken;
            currentUser = JSON.parse(savedUser);
            
            // VERIFICAR se o token ainda √© v√°lido
            fetch(`${SERVER_URL}/api/auth/verify`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            }).then(response => {
                if (response.ok) {
                    showMainSystem();
                    connectWebSocket();
                } else {
                    // Token inv√°lido - fazer logout
                    logout();
                }
            }).catch(() => {
                // Erro de conex√£o - mostrar login
                showLoginScreen();
            });
            
        } catch (error) {
            console.error('Erro ao verificar autentica√ß√£o:', error);
            showLoginScreen();
        }
    } else {
        showLoginScreen();
    }
}

    // Fun√ß√µes para modais
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        // if(modalId === 'resetPasswordModal') {
        //     document.getElementById('login-screen').classList.remove('hidden');
        // }
    }

    // ATUALIZADA: Abrir modal de dispositivo
    function openDeviceModal(device = null) {
        editingDeviceId = device ? device.id : null;
        const title = document.getElementById('deviceModalTitle');
        
        title.textContent = device ? 'Editar Dispositivo' : 'Adicionar Dispositivo';
        
        if (device) {
            document.getElementById('deviceId').value = device.id;
            document.getElementById('deviceName').value = device.name;
            document.getElementById('deviceLocation').value = device.location;
            document.getElementById('devicePlaylist').value = device.playlistId || '';
            
            // Para edi√ß√£o, mostrar MAC como informa√ß√£o (n√£o edit√°vel)
            document.getElementById('deviceIpLabel').textContent = 'MAC Address:';
            document.getElementById('deviceIp').value = device.mac || 'N/A';
            document.getElementById('deviceIp').readOnly = true;
            document.getElementById('deviceIp').placeholder = 'MAC address do dispositivo';
        } else {
            document.getElementById('deviceForm').reset();
            // Para novo dispositivo, mostrar campo de c√≥digo
            document.getElementById('deviceIpLabel').textContent = 'C√≥digo de Ativa√ß√£o *';
            document.getElementById('deviceIp').placeholder = 'Digite o c√≥digo de 6 d√≠gitos';
            document.getElementById('deviceIp').readOnly = false;
        }
        
        loadPlaylistOptions();
        openModal('deviceModal');
    }

    // NOVO: Mostrar p√°gina de configura√ß√£o do dispositivo
    function showDeviceConfig(device) {
        loadAllData ();
        currentConfigDevice = device;
        
        // Atualizar t√≠tulo
        document.getElementById('device-config-title').textContent = `Configura√ß√£o: ${device.name}`;
        
        // Preencher informa√ß√µes do dispositivo
        document.getElementById('configDeviceName').value = device.name;
        document.getElementById('configDeviceLocation').value = device.location;
        document.getElementById('configDeviceMac').textContent = device.mac || 'N/A';
        document.getElementById('configDeviceStatus').textContent = device.status === 'active' ? 'Ativo' : 'Pendente';
        
        // Carregar op√ß√µes de playlist
        loadConfigPlaylistOptions(device.playlistId);
        
        // Configurar √°udio (padr√£o: desligado)
        document.getElementById('configDeviceAudio').checked = device.audioEnabled || false;

        // Configurar developer (padr√£o: desligado)
        document.getElementById('configDeviceDeveloper').checked = device.developer|| false;
        
        // Configurar rota√ß√£o (padr√£o: horizontal)
        const rotation = device.rotation || 'horizontal';
        document.getElementById('configDeviceRotation').value = rotation;
        selectRotation(rotation);
        
        // Mostrar p√°gina de configura√ß√£o
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById('device-config').classList.add('active');
        
        // document.getElementById('page-title').textContent = `Configura√ß√£o: ${device.name}`;
        
        // Solicitar informa√ß√µes atuais do dispositivo
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'request_preview',
                deviceId: device.id
            }));
        }
    }

    // NOVO: Voltar para lista de dispositivos
    function showDevicesList() {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById('devices').classList.add('active');
        
        document.getElementById('page-title').textContent = 'Dispositivos';
        currentConfigDevice = null;
    }

    // NOVO: Carregar op√ß√µes de playlist para configura√ß√£o
async function loadConfigPlaylistOptions(selectedPlaylistId = null) {
        const select = document.getElementById('configDevicePlaylist');

        // GARANTIR que as playlists est√£o carregadas
        if (currentPlaylists.length === 0) {
            await loadPlaylists();
        }
        

        select.innerHTML = '<option value="">Todas as m√≠dias</option>';
        
        currentPlaylists.forEach(playlist => {
            const option = document.createElement('option');
            option.value = playlist.id;
            option.textContent = playlist.name;
            option.selected = (playlist.id === selectedPlaylistId);
            select.appendChild(option);
        });
    }

    // NOVO: Selecionar rota√ß√£o
    function selectRotation(rotation) {
        // Remover sele√ß√£o anterior
        document.querySelectorAll('.rotation-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Adicionar sele√ß√£o atual
        const selectedOption = document.querySelector(`.rotation-option[data-rotation="${rotation}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
        
        // Atualizar valor oculto
        document.getElementById('configDeviceRotation').value = rotation;
        
        // Aplicar rota√ß√£o na tela de preview
        const screenContent = document.querySelector('.current-media-info');
        screenContent.className = 'current-media-info';
        screenContent.classList.add(`rotation-${rotation}`);
    }

// NOVO: Salvar configura√ß√µes do dispositivo - CORRIGIDO
async function saveDeviceConfig() {
    if (!currentConfigDevice) return;
    
    const deviceData = {
        name: document.getElementById('configDeviceName').value,
        location: document.getElementById('configDeviceLocation').value,
        playlistId: document.getElementById('configDevicePlaylist').value || null,
        audioEnabled: document.getElementById('configDeviceAudio').checked,
        rotation: document.getElementById('configDeviceRotation').value,
        developer: document.getElementById('configDeviceDeveloper').checked
    };
    
    try {
        const response = await authenticatedFetch(`${SERVER_URL}/api/devices/${currentConfigDevice.id}`, {
            method: 'PUT',
            body: JSON.stringify(deviceData)
        });
        
        if (response.ok) {
            const updatedDevice = await response.json();
            showNotification('Configura√ß√µes do dispositivo salvas com sucesso!');
            
            // Atualizar dispositivo na lista local
            const deviceIndex = currentDevices.findIndex(d => d.id === currentConfigDevice.id);
            if (deviceIndex !== -1) {
                currentDevices[deviceIndex] = updatedDevice;
            }
            
            // Atualizar informa√ß√µes na tela
            currentConfigDevice = updatedDevice;
            document.getElementById('device-config-title').textContent = `Configura√ß√£o: ${updatedDevice.name}`;
            document.getElementById('configDeviceStatus').textContent = updatedDevice.status === 'active' ? 'Ativo' : 'Pendente';
            
            // NOVO: Atualizar visualiza√ß√£o da rota√ß√£o
            selectRotation(updatedDevice.rotation);

            loadAllData();
        }
    } catch (error) {
        showNotification('Erro ao salvar configura√ß√µes: ' + error.message, 'error');
    }
}

    // NOVO: Desconectar dispositivo da tela de configura√ß√£o
    async function disconnectConfigDevice() {
        if (!currentConfigDevice) return;
        
        const confirmed = await showConfirmation(
            'Deseja desconectar este dispositivo? Ele precisar√° ser reativado com um novo c√≥digo.',
            'Desconectar Dispositivo'
        );
        
        if (!confirmed) return;
        
        try {
            await disconnectDevice(currentConfigDevice.id);
            showDevicesList();
        } catch (error) {
            showNotification('Erro ao desconectar dispositivo: ' + error.message, 'error');
        }
    }

    function openEditMediaModal(mediaItem) {
        document.getElementById('editMediaId').value = mediaItem.id;
        document.getElementById('editMediaName').value = mediaItem.originalName;
        document.getElementById('editMediaDisplayTime').value = mediaItem.displayTime;
        
        const urlGroup = document.getElementById('editMediaUrlGroup');
        const urlInput = document.getElementById('editMediaUrl');
        
        if (mediaItem.isExternal) {
            urlGroup.style.display = 'block';
            urlInput.value = mediaItem.path;
            urlInput.required = true;
        } else {
            urlGroup.style.display = 'none';
            urlInput.required = false;
        }
        
        openModal('editMediaModal');
    }

function openPlaylistModal(playlist = null) {
    editingPlaylistId = playlist ? playlist.id : null;
    const title = document.getElementById('playlistModalTitle');
    
    title.textContent = playlist ? 'Editar Playlist' : 'Criar Playlist';
    
    if (playlist) {
        document.getElementById('playlistId').value = playlist.id;
        document.getElementById('playlistName').value = playlist.name;
    } else {
        document.getElementById('playlistForm').reset();
    }
    
    // Usar valores padr√£o se as propriedades n√£o existirem
    const mediaIds = playlist ? (playlist.mediaIds || []) : [];
    const campaignIds = playlist ? (playlist.campaignIds || []) : [];
    const mediaOrder = playlist ? (playlist.mediaOrder || []) : [];
    const campaignOrder = playlist ? (playlist.campaignOrder || []) : [];
    
    renderPlaylistMediaCheckboxes(mediaIds, mediaOrder);
    renderPlaylistCampaignCheckboxes(campaignIds, campaignOrder);
    updatePlaylistOrderPreview(playlist);
    
    // Inicializar tabs de conte√∫do
    initPlaylistContentTabs();
    
    openModal('playlistModal');
    
    // Inicializar observers para atualizar o preview
    setTimeout(() => {
        initPlaylistCheckboxObservers();
        updatePlaylistOrderPreview(playlist);
    }, 100);
}


// Inicializar tabs de conte√∫do da playlist
function initPlaylistContentTabs() {
    document.querySelectorAll('.content-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Remover active de todas as tabs e conte√∫dos
            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.playlist-content').forEach(c => c.classList.remove('active'));
            
            // Adicionar active na tab e conte√∫do clicados
            this.classList.add('active');
            const contentId = this.dataset.content + 'Content';
            document.getElementById('playlist' + contentId.charAt(0).toUpperCase() + contentId.slice(1)).classList.add('active');
        });
    });
}
// Renderizar checkboxes de m√≠dias para playlist
function renderPlaylistMediaCheckboxes(selectedMediaIds = [], mediaOrder = []) {
    const container = document.getElementById('mediaCheckboxes');
    container.innerHTML = '';
    
    if (currentMedia.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhuma m√≠dia dispon√≠vel</p>';
        return;
    } 
    
    let mediaToShow = currentMedia;
    // if (mediaOrder.length > 0) {
    //     mediaToShow = mediaOrder.map(id => currentMedia.find(m => m.id === id)).filter(Boolean);
    // } else {
        mediaToShow.sort((a, b) => (a.order || 0) - (b.order || 0));
    // }
    
    mediaToShow.forEach(mediaItem => {
        const div = document.createElement('div');
        div.className = 'media-checkbox-item';
        div.draggable = true;
        div.dataset.id = mediaItem.id;
        div.dataset.type = 'media';
        
        const isChecked = selectedMediaIds.includes(mediaItem.id);
        const mediaTypeIcon = mediaItem.mediaType === 'youtube' ? 'üì∫' : 
                           mediaItem.mediaType === 'website' ? 'üåê' : 
                           mediaItem.type === 'image' ? 'üñºÔ∏è' : 'üé•';
        
        div.innerHTML = `
            <input type="checkbox" value="${mediaItem.id}" ${isChecked ? 'checked' : ''}>
            <span class="drag-handle">‚†ø</span>
            <span style="flex: 1;">
                <strong>${mediaItem.originalName}</strong>
                <br>
                <small style="color: #666;">
                    ${mediaTypeIcon} ${mediaItem.mediaType || 'upload'} 
                    ‚Ä¢ ${mediaItem.displayTime}s
                    ${mediaItem.type ? `‚Ä¢ ${mediaItem.type}` : ''}
                </small>
            </span>
        `;
        container.appendChild(div);
    });
    
    initPlaylistMediaDragAndDrop();
}

// Inicializar drag and drop para m√≠dias na playlist
function initPlaylistMediaDragAndDrop() {
    const container = document.getElementById('playlistOrderList');
    let draggedItem = null;
    
    container.querySelectorAll('.media-checkbox-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', function() {
            this.style.opacity = '1';
            draggedItem = null;
            updatePlaylistOrderPreview();
        });
        
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        item.addEventListener('drop', function(e) {
            e.preventDefault();
            if (draggedItem && draggedItem !== this) {
                const container = this.parentNode;
                if (draggedItem.parentNode === container) {
                    const fromIndex = Array.from(container.children).indexOf(draggedItem);
                    const toIndex = Array.from(container.children).indexOf(this);
                    
                    if (fromIndex < toIndex) {
                        container.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, this);
                    }
                    updatePlaylistOrderPreview();
                }
            }
        });
    });
}
// Renderizar checkboxes de campanhas para playlist
function renderPlaylistCampaignCheckboxes(selectedCampaignIds = [], campaignOrder = []) {
    const container = document.getElementById('campaignCheckboxes');
    container.innerHTML = '';
    
    if (currentCampaigns.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhuma campanha dispon√≠vel</p>';
        return;
    }
    
    let campaignsToShow = currentCampaigns;
    // if (campaignOrder.length > 0) {
    //     campaignsToShow = campaignOrder.map(id => currentCampaigns.find(c => c.id === id)).filter(Boolean);
    // }
    
    campaignsToShow.forEach(campaign => {
        const div = document.createElement('div');
        div.className = 'campaign-checkbox-item';
        div.draggable = true;
        div.dataset.id = campaign.id;
        div.dataset.type = 'campaign';
        
        const isChecked = selectedCampaignIds.includes(campaign.id);
        
        div.innerHTML = `
            <input type="checkbox" value="${campaign.id}" ${isChecked ? 'checked' : ''}>
            <span class="drag-handle">‚†ø</span>
            <span style="flex: 1;">
                <strong>${campaign.name}</strong>
                <br>
                <small style="color: #666;">
                    üéØ Campanha ‚Ä¢ ${campaign.mediaIds.length} m√≠dia(s)
                </small>
            </span>
        `;
        container.appendChild(div);
    });
    
    initPlaylistCampaignDragAndDrop();
}

// Inicializar drag and drop para campanhas na playlist
function initPlaylistCampaignDragAndDrop() {
    const container = document.getElementById('campaignCheckboxes');
    let draggedItem = null;
    
    container.querySelectorAll('.campaign-checkbox-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', function() {
            this.style.opacity = '1';
            draggedItem = null;
            updatePlaylistOrderPreview();
        });
        
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        item.addEventListener('drop', function(e) {
            e.preventDefault();
            if (draggedItem && draggedItem !== this) {
                const container = this.parentNode;
                if (draggedItem.parentNode === container) {
                    const fromIndex = Array.from(container.children).indexOf(draggedItem);
                    const toIndex = Array.from(container.children).indexOf(this);
                    
                    if (fromIndex < toIndex) {
                        container.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, this);
                    }
                    updatePlaylistOrderPreview();
                }
            }
        });
    });
}


// Atualizar preview da ordem da playlist COM DRAG & DROP
function updatePlaylistOrderPreview(playlist = null) {
    const container = document.getElementById('playlistOrderList');
    container.innerHTML = '';
    
    // Coletar todas as m√≠dias selecionadas
    const selectedMedia = Array.from(document.querySelectorAll('#mediaCheckboxes input[type="checkbox"]:checked'))
        .map(checkbox => {
            const item = checkbox.closest('.media-checkbox-item');
            return {
                id: item.dataset.id,
                name: item.querySelector('strong').textContent,
                type: 'media'
            };
        });
    
    // Coletar todas as campanhas selecionadas
    const selectedCampaigns = Array.from(document.querySelectorAll('#campaignCheckboxes input[type="checkbox"]:checked'))
        .map(checkbox => {
            const item = checkbox.closest('.campaign-checkbox-item');
            return {
                id: item.dataset.id,
                name: item.querySelector('strong').textContent,
                type: 'campaign'
            };
        });
    
    // Combinar todos os itens
    let allItems = [...selectedMedia, ...selectedCampaigns];
    
    // Se temos uma playlist com contentOrder, usar essa ordem
    if (playlist && playlist.contentOrder && playlist.contentOrder.length > 0) {
        const orderedItems = [];
        playlist.contentOrder.forEach(orderedItem => {
            const foundItem = allItems.find(item => item.id === orderedItem.id && item.type === orderedItem.type);
            if (foundItem) {
                orderedItems.push(foundItem);
            }
        });
        // Adicionar quaisquer itens novos que n√£o estavam na ordem antiga
        allItems.forEach(item => {
            if (!orderedItems.find(oi => oi.id === item.id && oi.type === item.type)) {
                orderedItems.push(item);
            }
        });
        allItems = orderedItems;
    }
    
    if (allItems.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">Nenhum item selecionado</p>';
        return;
    }
    
    allItems.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `playlist-order-item ${item.type}`;
        div.draggable = true;
        div.dataset.id = item.id;
        div.dataset.type = item.type;
        
        div.innerHTML = `
            <span class="drag-handle">‚†ø</span>
            <span style="flex: 1;">
                <strong>${item.name}</strong>
                <br>
                <small style="color: #666;">
                    ${item.type === 'media' ? 'üìÑ M√≠dia' : 'üéØ Campanha'}
                    ‚Ä¢ Posi√ß√£o ${index + 1}
                </small>
            </span>
        `;
        container.appendChild(div);
    });
    
    // Inicializar drag and drop na preview da ordem
    initPlaylistOrderDragAndDrop();
}

// Inicializar drag and drop na ordem da playlist
function initPlaylistOrderDragAndDrop() {
    const container = document.getElementById('playlistOrderList');
    let draggedItem = null;
    
    container.querySelectorAll('.playlist-order-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', function() {
            this.style.opacity = '1';
            draggedItem = null;
        });
        
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        item.addEventListener('drop', function(e) {
            e.preventDefault();
            if (draggedItem && draggedItem !== this) {
                const container = this.parentNode;
                if (draggedItem.parentNode === container) {
                    const fromIndex = Array.from(container.children).indexOf(draggedItem);
                    const toIndex = Array.from(container.children).indexOf(this);
                    
                    if (fromIndex < toIndex) {
                        container.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, this);
                    }
                    
                    // Atualizar a ordem visualmente
                    updatePlaylistOrderNumbers();
                }
            }
        });
    });
}


// Atualizar n√∫meros de posi√ß√£o na ordem
function updatePlaylistOrderNumbers() {
    const container = document.getElementById('playlistOrderList');
    const items = container.querySelectorAll('.playlist-order-item');
    
    items.forEach((item, index) => {
        const small = item.querySelector('small');
        const type = item.dataset.type === 'media' ? 'üìÑ M√≠dia' : 'üéØ Campanha';
        small.innerHTML = `${type} ‚Ä¢ Posi√ß√£o ${index + 1}`;
    });
}
// Observar mudan√ßas nos checkboxes para atualizar o preview
function initPlaylistCheckboxObservers() {
    // Observar mudan√ßas nas m√≠dias
    document.querySelectorAll('#mediaCheckboxes input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updatePlaylistOrderPreview);
    });
    
    // Observar mudan√ßas nas campanhas
    document.querySelectorAll('#campaignCheckboxes input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updatePlaylistOrderPreview);
    });
}


    function openAnnouncementModal() {
        loadMediaOptions('announcementMedia');
        loadDeviceCheckboxes();
        openModal('announcementModal');
    }

    function openDevicePreview(device) {
        document.getElementById('devicePreviewTitle').textContent = `Visualiza√ß√£o: ${device.name}`;
        document.getElementById('devicePreviewInfo').textContent = `${device.location} - ${device.mac || 'N/A'}`;
        
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'request_preview',
                deviceId: device.id
            }));
        }
        
        openModal('devicePreviewModal');
        
        if (devicePreviewInterval) clearInterval(devicePreviewInterval);
        devicePreviewInterval = setInterval(() => {
            updateDevicePreviewStatus(device);
        }, 5000);
    }

    function updateDevicePreview(data) {
        const preview = document.getElementById('devicePreview');
        const status = document.getElementById('devicePreviewStatus');
        
        if (data.media) {
            preview.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; color: white;">
                    <h3>${data.media.originalName}</h3>
                    <p>${data.media.mediaType || 'upload'} ‚Ä¢ ${data.media.displayTime}s</p>
                    <p style="font-size: 12px; color: #ccc;">√öltima atualiza√ß√£o: ${new Date(data.timestamp).toLocaleTimeString()}</p>
                </div>
            `;
            preview.classList.add('live');
        }
        
        status.innerHTML = `
            <strong>Reproduzindo:</strong> ${data.media.originalName}<br>
            <strong>Tipo:</strong> ${data.media.mediaType || 'upload'}<br>
            <strong>Tempo:</strong> ${data.media.displayTime}s<br>
            <strong>√öltima atualiza√ß√£o:</strong> ${new Date(data.timestamp).toLocaleString()}
        `;
    }

    function updateDevicePreviewStatus(device) {
        const status = document.getElementById('devicePreviewStatus');
        const now = new Date();
        const lastSeen = new Date(device.lastSeen);
        const diffMinutes = (now - lastSeen) / (1000 * 60);
        
        if (diffMinutes < 2) {
            status.innerHTML = `<span style="color: var(--success);">‚úÖ Online - Ativo agora</span>`;
        } else if (diffMinutes < 10) {
            status.innerHTML = `<span style="color: var(--warning);">üü° Online - Visto h√° ${Math.floor(diffMinutes)} min</span>`;
        } else {
            status.innerHTML = `<span style="color: var(--danger);">üî¥ Offline - √öltima vez: ${lastSeen.toLocaleString()}</span>`;
        }
    }

    // Carregar op√ß√µes
    function loadPlaylistOptions() {
        const select = document.getElementById('devicePlaylist');
        select.innerHTML = '<option value="">Todas as m√≠dias</option>';
        
        currentPlaylists.forEach(playlist => {
            const option = document.createElement('option');
            option.value = playlist.id;
            option.textContent = playlist.name;
            select.appendChild(option);
        });
    }

    function loadMediaOptions(selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Selecione uma m√≠dia...</option>';
        
        currentMedia.forEach(media => {
            const option = document.createElement('option');
            option.value = media.id;
            option.textContent = `${media.originalName} (${media.mediaType || 'upload'} - ${media.displayTime}s)`;
            select.appendChild(option);
        });
    }

    function loadDeviceCheckboxes() {
        const container = document.getElementById('announcementDevicesCheckboxes');
        container.innerHTML = '';
        
        const activeDevices = currentDevices.filter(d => d.status === 'active');
        
        if (activeDevices.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center;">Nenhum dispositivo ativo</p>';
            return;
        }
        
        activeDevices.forEach(device => {
            const div = document.createElement('div');
            div.className = 'media-checkbox-item';
            div.innerHTML = `
                <input type="checkbox" value="${device.id}" id="device_${device.id}">
                <label for="device_${device.id}" style="flex: 1;">
                    <strong>${device.name}</strong>
                    <br>
                    <small style="color: #666;">${device.location} - ${device.mac || 'N/A'}</small>
                </label>
            `;
            container.appendChild(div);
        });
    }

    // Renderizar listas com drag & drop
    function renderMediaList() {
        const container = document.getElementById('mediaList');
        container.innerHTML = '';
        
        if (currentMedia.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma m√≠dia cadastrada</p>';
            return;
        }
        
        const sortedMedia = [...currentMedia].sort((a, b) => (a.order || 0) - (b.order || 0));
        
        sortedMedia.forEach(mediaItem => {
            const mediaElement = createMediaListItem(mediaItem);
            container.appendChild(mediaElement);
        });
        
        initDragAndDrop();
    }

    function createMediaListItem(mediaItem) {
        const div = document.createElement('div');
        div.className = 'media-list-item';
        div.draggable = true;
        div.dataset.id = mediaItem.id;
        
        const mediaTypeIcon = mediaItem.mediaType === 'youtube' ? 'üì∫' : 
                           mediaItem.mediaType === 'website' ? 'üåê' : 
                           mediaItem.type === 'image' ? 'üñºÔ∏è' : 'üé•';
        
        let previewContent = '';
        if (mediaItem.isExternal) {
            previewContent = `<div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border-radius: 6px;">${mediaItem.mediaType === 'youtube' ? 'üì∫' : 'üåê'}</div>`;
        } else if (mediaItem.type === 'image') {
            previewContent = `<img src="${SERVER_URL}${mediaItem.path}" alt="${mediaItem.originalName}" class="media-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
        } else {
            previewContent = `<div style="width: 60px; height: 60px; background: #2c3e50; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border-radius: 6px;">üé•</div>`;
        }
        
        div.innerHTML = `
            <div class="drag-handle">‚†ø</div>
            ${previewContent}
            <!-- <div style="display: none; width: 60px; height: 60px; background: #ecf0f1; display: flex; align-items: center; justify-content: center; color: #666; border-radius: 6px;">
                ${mediaTypeIcon}
            </div>-->
            <div class="media-list-info">
                <h4>${mediaItem.originalName}</h4>
                <p>${mediaTypeIcon} ${mediaItem.mediaType || 'upload'} ‚Ä¢ ${mediaItem.displayTime}s</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-warning btn-sm" onclick="openEditMediaModal(${JSON.stringify(mediaItem).replace(/"/g, '&quot;')})">
                    Editar
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteMedia('${mediaItem.id}')">
                    Excluir
                </button>
            </div>
        `;
        
        return div;
    }

    function initDragAndDrop() {
        const container = document.getElementById('mediaList');
        let draggedItem = null;
        
        container.querySelectorAll('.media-list-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedItem = null;
            });
            
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            item.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedItem && draggedItem !== this) {
                    const container = this.parentNode;
                    const items = Array.from(container.children);
                    const fromIndex = items.indexOf(draggedItem);
                    const toIndex = items.indexOf(this);
                    
                    if (fromIndex < toIndex) {
                        container.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, this);
                    }
                    
                    saveMediaOrder();
                }
            });
        });
    }

    async function saveMediaOrder() {
        const container = document.getElementById('mediaList');
        const items = Array.from(container.children);
        const mediaOrder = items.map((item, index) => ({
            id: item.dataset.id,
            order: index + 1
        }));
        
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/media/reorder`, {
                method: 'POST',
                body: JSON.stringify({ mediaOrder })
            });
            
            if (response.ok) {
                showNotification('Ordem das m√≠dias salva com sucesso!');
                loadAllData();
            }
        } catch (error) {
            showNotification('Erro ao salvar ordem das m√≠dias', 'error');
        }
    }

    function renderMediaCheckboxes(selectedMediaIds = [], mediaOrder = []) {
        const container = document.getElementById('mediaCheckboxes');
        container.innerHTML = '';
        
        if (currentMedia.length === 0) {
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhuma m√≠dia dispon√≠vel</p>';
            return;
        }
        
        let mediaToShow = currentMedia;
        if (mediaOrder.length > 0) {
            mediaToShow = mediaOrder.map(id => currentMedia.find(m => m.id === id)).filter(Boolean);
        } else {
            mediaToShow.sort((a, b) => (a.order || 0) - (b.order || 0));
        }
        
        mediaToShow.forEach(mediaItem => {
            const div = document.createElement('div');
            div.className = 'media-checkbox-item';
            div.draggable = true;
            div.dataset.id = mediaItem.id;
            
            const isChecked = selectedMediaIds.includes(mediaItem.id);
            const mediaTypeIcon = mediaItem.mediaType === 'youtube' ? '' : 
                               mediaItem.mediaType === 'website' ? '' : 
                               mediaItem.type === 'image' ? '' : '';
            
            div.innerHTML = `
                <input type="checkbox" value="${mediaItem.id}" ${isChecked ? 'checked' : ''}>
                <span class="drag-handle">‚†ø</span>
                <span style="flex: 1;">
                    <strong>${mediaItem.originalName}</strong>
                    <br>
                    <small style="color: #666;">
                        ${mediaTypeIcon} ${mediaItem.mediaType || 'upload'} 
                        ‚Ä¢ ${mediaItem.displayTime}s
                    </small>
                </span>
            `;
            container.appendChild(div);
        });
        
        initPlaylistDragAndDrop();
    }

    function initPlaylistDragAndDrop() {
        const container = document.getElementById('mediaCheckboxes');
        let draggedItem = null;
        
        container.querySelectorAll('.media-checkbox-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
            });
            
            item.addEventListener('dragend', function() {
                this.style.opacity = '1';
                draggedItem = null;
            });
            
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            item.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedItem && draggedItem !== this) {
                    const container = this.parentNode;
                    if (draggedItem.parentNode === container) {
                        const fromIndex = Array.from(container.children).indexOf(draggedItem);
                        const toIndex = Array.from(container.children).indexOf(this);
                        
                        if (fromIndex < toIndex) {
                            container.insertBefore(draggedItem, this.nextSibling);
                        } else {
                            container.insertBefore(draggedItem, this);
                        }
                    }
                }
            });
        });
    }

// CORRIGIDA: Fun√ß√£o para fazer requisi√ß√µes autenticadas

async function authenticatedFetch(url, options = {}) {
    // VERIFICAR se est√° autenticado
    if (!authToken) {
        console.log('Token n√£o dispon√≠vel para requisi√ß√£o autenticada');
        throw new Error('Sess√£o expirada');
    }

    // Criar cabe√ßalhos a partir dos passados (evitar sobrescrever)
    const headers = new Headers(options.headers || {});
    headers.set('Authorization', `Bearer ${authToken}`);

    // Se o corpo for FormData, N√ÉO definir Content-Type (o browser define o boundary)
    const body = options.body;
    if (!(body instanceof FormData)) {
        // Se o caller n√£o definiu Content-Type, assumir JSON para objetos/string
        if (!headers.has('Content-Type')) {
            headers.set('Content-Type', 'application/json');
        }
    } else {
        // Garantir que n√£o for√ßamos Content-Type
        headers.delete('Content-Type');
    }

    const fetchOptions = {
        method: options.method || 'GET',
        headers,
        body: body === undefined ? undefined : body,
        credentials: options.credentials || 'same-origin'
    };

    try {
        const response = await fetch(url, fetchOptions);

        if (response.status === 401 || response.status === 403) {
            // Sess√£o expirada - logout controlado
            console.log('Sess√£o expirada, fazendo logout.');
            if (!window.logoutInProgress) {
                window.logoutInProgress = true;
                showNotification('Sess√£o expirada. Fa√ßa login novamente.', 'error');
                setTimeout(() => {
                    logout();
                    window.logoutInProgress = false;
                }, 1200);
            }
            throw new Error('Sess√£o expirada');
        }

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erro na resposta:', response.status, errorText);
            throw new Error(`Erro ${response.status}: ${errorText}`);
        }

        return response;
    } catch (err) {
        if (err.message === 'Sess√£o expirada') throw err;
        console.error('‚ùå Erro na requisi√ß√£o:', err);
        throw new Error('Erro de conex√£o com o servidor');
    }
}


// NOVA: Fun√ß√£o para verificar se est√° autenticado antes de carregar dados
function shouldLoadData() {
    return authToken && currentUser;
}

// ATUALIZAR: Fun√ß√£o loadAllData para verificar autentica√ß√£o
async function loadAllData() {
    // VERIFICAR se est√° autenticado antes de carregar
    if (!shouldLoadData()) {
        console.log('‚è≥ Aguardando autentica√ß√£o para carregar dados...');
        return;
    }
    
    try {
        await loadMedia();
        await loadPlaylists();
        await loadAnnouncements();
        await loadDevices();
        await loadCampaigns();


        if (currentUser.role === 'admin') {
            await loadUsers();
        }
        updateStats();
        updateDevicesTable();
        initMediaTabs(); 
    } catch (error) {
        if (error.message === 'Sess√£o expirada') {
            // J√° foi tratado no authenticatedFetch
            return;
        }
        console.error('Erro ao carregar dados:', error);
        showNotification('Erro ao carregar dados do sistema', 'error');
    }
}

    async function loadDevices() {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/devices`);
            if (response.ok) {
                currentDevices = await response.json();
                renderDevicesList();
            }
        } catch (error) {
            console.error('Erro ao carregar dispositivos:', error);
            showNotification('Erro ao carregar dispositivos', 'error');
        }
    }

    async function loadMedia() {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/media`);
            if (response.ok) {
                currentMedia = await response.json();
                renderMediaList();
            }
        } catch (error) {
            console.error('Erro ao carregar m√≠dias:', error);
            showNotification('Erro ao carregar m√≠dias', 'error');
        }
    }

    async function loadPlaylists() {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/playlists`);
            if (response.ok) {
                currentPlaylists = await response.json();
                renderPlaylistsList();
            }
        } catch (error) {
            console.error('Erro ao carregar playlists:', error);
            showNotification('Erro ao carregar playlists', 'error');
        }
    }

    async function loadAnnouncements() {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/announcements`);
            if (response.ok) {
                currentAnnouncements = await response.json();
                renderAnnouncementsList();
            }
        } catch (error) {
            console.error('Erro ao carregar anunciamentos:', error);
        }
    }

    async function loadUsers() {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/users`);
            if (response.ok) {
                currentUsers = await response.json();
                renderUsersList();
            }
        } catch (error) {
            console.error('Erro ao carregar usu√°rios:', error);
            showNotification('Erro ao carregar usu√°rios', 'error');
        }
    }

    // ATUALIZADA: Renderizar lista de dispositivos - REMOVER bot√µes e adicionar link para configura√ß√£o
    function renderDevicesList() {
        const tbody = document.querySelector('#devicesListTable tbody');
        tbody.innerHTML = '';
        
        currentDevices = currentDevices.filter(device => device.userId !== null);

        currentDevices.forEach(device => {
            const playlistName = device.playlistId ? 
                currentPlaylists.find(p => p.id === device.playlistId)?.name || 'Playlist n√£o encontrada' : 
                'Todas as m√≠dias';
            
            // Formatar √∫ltima atividade
            let lastSeenText = 'Nunca';
            if (device.lastSeen) {
                const lastSeen = new Date(device.lastSeen);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastSeen) / (1000 * 60));
                
                if (diffMinutes < 1) {
                    lastSeenText = 'Agora mesmo';
                } else if (diffMinutes < 60) {
                    lastSeenText = `H√° ${diffMinutes} min`;
                } else {
                    lastSeenText = lastSeen.toLocaleString();
                }
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td id="tName">
                    <strong>${device.name}</strong>
                    ${device.mac ? `<br><small style="color: #666;">MAC: ${device.mac}</small>` : ''}
                </td>
                <td id="tLocation">${device.location}</td>
                <td id="tStatus"><span class="status-${device.status}">${device.status === 'active' ? 'Ativo' : 'Pendente'}</span></td>
                <td id="tCode">
                    ${device.status === 'pending' ? 
                        `<span class="auth-code">${device.authCode}</span><br>
                         <small style="color: #e74c3c;">Expira: ${device.codeExpiry ? new Date(device.codeExpiry).toLocaleTimeString() : 'N/A'}</small>` : 
                        '<span style="color: #27ae60;">Ativado</span>'
                    }
                </td>
                <td id="tPlaylist">${playlistName}</td>
                <td id="tLastSeen">${lastSeenText}</td>
                <td id="tActionButtons" class="action-buttons">
                    <button class="butn btn-primary btn-sm" onclick="showDeviceConfig(${JSON.stringify(device).replace(/"/g, '&quot;')})">
                        <i class="ti ti-settings"></i> Configurar
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

function renderPlaylistsList() {
    const container = document.getElementById('playlistsList');
    container.innerHTML = '';
    
    if (!currentPlaylists || currentPlaylists.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma playlist criada</p>';
        return;
    }
    
    currentPlaylists.forEach(playlist => {
        const playlistElement = document.createElement('div');
        playlistElement.className = 'card';
        playlistElement.style.marginBottom = '15px';
        
        // Usar valores padr√£o se as propriedades n√£o existirem
        const mediaIds = playlist.mediaIds || [];
        const campaignIds = playlist.campaignIds || [];
        const mediaCount = mediaIds.length;
        const campaignCount = campaignIds.length;
        const totalItems = mediaCount + campaignCount;
        
        const assignedDevices = currentDevices.filter(d => d.playlistId === playlist.id);
        const activeDevices = assignedDevices.filter(d => d.status === 'active');
        const hasCustomOrder = playlist.contentOrder && playlist.contentOrder.length > 0;
        
        playlistElement.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 10px 0;">${playlist.name}</h3>
                    <p style="margin: 0 0 10px 0; color: #666;">
                        üìÅ ${totalItems} item(s) ‚Ä¢ ${mediaCount} m√≠dia(s) ‚Ä¢ ${campaignCount} campanha(s)
                        ${assignedDevices.length > 0 ? `‚Ä¢ ${assignedDevices.length} dispositivo(s)` : ''}
                        ${activeDevices.length > 0 ? `‚Ä¢ ${activeDevices.length} ativo(s)` : ''}
                        ${hasCustomOrder ? '‚Ä¢ Ordem personalizada' : ''}
                    </p>
                    
                    ${activeDevices.length > 0 ? `
                    <div class="playlist-sync-info">
                        <strong>Dispositivos Ativos:</strong>
                        <div style="margin-top: 5px;">
                            ${activeDevices.map(device => 
                                `<span class="device-tag" style="margin-right: 5px; margin-bottom: 5px;">${device.name}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${activeDevices.length > 0 ? `
                        <button class="btn btn-success btn-sm sync-playlist-btn" data-playlist-id="${playlist.id}">
                            Sincronizar Playlist
                        </button>
                        ` : ''}
                        <button class="btn btn-warning btn-sm" onclick="openPlaylistModal(${JSON.stringify(playlist).replace(/"/g, '&quot;')})">
                            Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePlaylist('${playlist.id}')">
                            Excluir
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(playlistElement);
    });
    
    // Re-inicializar bot√µes de sync
    setTimeout(() => {
        document.querySelectorAll('.sync-playlist-btn').forEach(btn => {
            btn.replaceWith(btn.cloneNode(true));
        });
        
        document.querySelectorAll('.sync-playlist-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const playlistId = this.getAttribute('data-playlist-id');
                syncPlaylist(playlistId);
            });
        });
    }, 100);
}

    function renderAnnouncementsList() {
        const container = document.getElementById('announcementsList');
        container.innerHTML = '';
        
        if (currentAnnouncements.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum pronunciamento ativo</p>';
            return;
        }
        
        const activeAnnouncements = currentAnnouncements.filter(a => a.status === 'active');
        
        if (activeAnnouncements.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum pronunciamento ativo no momento</p>';
            return;
        }
        
        activeAnnouncements.forEach(announcement => {
            const media = currentMedia.find(m => m.id === announcement.mediaId);
            const deviceNames = announcement.deviceIds.map(deviceId => {
                const device = currentDevices.find(d => d.id === deviceId);
                return device ? device.name : 'Dispositivo desconhecido';
            });
            
            const announcementElement = document.createElement('div');
            announcementElement.className = 'announcement-card';
            
            announcementElement.innerHTML = `
                <div class="announcement-header">
                    <h4 style="margin: 0;">${announcement.name}</h4>
                    <span style="color: var(--warning); font-weight: bold;">${announcement.displayTime}s</span>
                </div>
                <p style="margin: 0 0 10px 0;">
                    <strong>M√≠dia:</strong> ${media ? media.originalName : 'N√£o encontrada'}
                </p>
                <div class="announcement-devices">
                    ${deviceNames.map(name => `<span class="device-tag">${name}</span>`).join('')}
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-danger btn-sm" onclick="cancelAnnouncement('${announcement.id}')">
                        Cancelar
                    </button>
                </div>
            `;
            
            container.appendChild(announcementElement);
        });
    }

    function renderUsersList() {
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        
        currentUsers.forEach(user => {
            const tr = document.createElement('tr');
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Nunca';
            
            tr.innerHTML = `
                <td>${user.name}</td>
                <td>${user.username}</td>
                <td>${user.role === 'admin' ? 'Administrador' : 'Usu√°rio'}</td>
                <td>${new Date(user.createdAt).toLocaleString()}</td>
                <td>${lastLogin}</td>
                <td>
                    ${user.id !== currentUser.id ? `
                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">
                        Excluir
                    </button>
                    ` : '<em>Usu√°rio atual</em>'}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ==================== FUN√á√ïES CRUD ====================

    // ATUALIZADA: Salvar dispositivo (agora por c√≥digo)
    async function saveDevice(deviceData) {
        try {
            // Se √© edi√ß√£o, usar rota normal
            if (deviceData.id) {
                const url = `${SERVER_URL}/api/devices/${deviceData.id}`;
                const response = await authenticatedFetch(url, {
                    method: 'PUT',
                    body: JSON.stringify(deviceData)
                });
                
                if (response.ok) {
                    const device = await response.json();
                    showNotification('Dispositivo atualizado com sucesso!');
                    closeModal('deviceModal');
                    await loadDevices();
                    return device;
                } else {
                    const error = await response.json();
                    throw new Error(error.error);
                }
            } else {
                // Se √© novo dispositivo, usar c√≥digo de ativa√ß√£o
                const authCode = document.getElementById('deviceIp').value;
                
                if (!authCode || authCode.length !== 6) {
                    throw new Error('C√≥digo de ativa√ß√£o deve ter 6 d√≠gitos');
                }
                
                const response = await authenticatedFetch(`${SERVER_URL}/api/devices`, {
                    method: 'POST',
                    body: JSON.stringify({
                        authCode: authCode,
                        name: deviceData.name,
                        location: deviceData.location,
                        playlistId: deviceData.playlistId,
                        audioEnabled: false, // NOVO: Padr√£o sem √°udio
                        rotation: 'horizontal',  // padr√£o horizontal
                        developer: false  
                    })
                });
                
                if (response.ok) {
                    const device = await response.json();
                    showNotification('Dispositivo adicionado com sucesso!');
                    closeModal('deviceModal');
                    await loadDevices();
                    return device;
                } else {
                    const error = await response.json();
                    throw new Error(error.error);
                }
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function deleteDevice() {
        if (!deviceId) return;

        const confirmed = await showConfirmation(
            'Tem certeza que deseja excluir este dispositivo? Esta a√ß√£o n√£o pode ser desfeita.',
            'Excluir Dispositivo'
        );
        
        if (!confirmed) return;
        
        try {

        // const disconnectResponse = await authenticatedFetch(`${SERVER_URL}/api/devices/${deviceId}/disconnect`, {
        //     method: 'POST'
        // });

        // if (disconnectResponse.ok) {

            const response = await authenticatedFetch(`${SERVER_URL}/api/devices/${deviceId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('Dispositivo exclu√≠do com sucesso!');
                await loadDevices();
                showDevicesList()
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }

        // } else {
        //     const error = await disconnectResponse.json();
        //     throw new Error(error.error);
        // }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // NOVA: Fun√ß√£o para desconectar dispositivo
    async function disconnectDevice(deviceId) {
        const confirmed = await showConfirmation(
            'Deseja desconectar este dispositivo? Ele precisar√° ser reativado com um novo c√≥digo.',
            'Desconectar Dispositivo'
        );
        
        if (!confirmed) return;
        
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/devices/${deviceId}/disconnect`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                showNotification('Dispositivo desconectado com sucesso!');
                await loadDevices();
                showDevicesList();
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // M√≠dias
    async function saveMedia(formData) {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/media`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const media = await response.json();
                showNotification('M√≠dia adicionada com sucesso!');
                closeModal('mediaModal');
                await loadMedia();
                return media;
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function saveExternalMedia(mediaData) {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/media/external`, {
                method: 'POST',
                body: JSON.stringify(mediaData)
            });
            
            if (response.ok) {
                const media = await response.json();
                showNotification('M√≠dia externa adicionada com sucesso!');
                closeModal('externalMediaModal');
                await loadMedia();
                return media;
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function updateMedia(mediaData) {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/media/${mediaData.id}`, {
                method: 'PUT',
                body: JSON.stringify(mediaData)
            });
            
            if (response.ok) {
                const media = await response.json();
                showNotification('M√≠dia atualizada com sucesso!');
                closeModal('editMediaModal');
                await loadMedia();
                return media;
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function deleteMedia(mediaId) {
        const confirmed = await showConfirmation(
            'Tem certeza que deseja excluir esta m√≠dia? Esta a√ß√£o n√£o pode ser desfeita.',
            'Excluir M√≠dia'
        );
        
        if (!confirmed) return;
        
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/media/${mediaId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('M√≠dia exclu√≠da com sucesso!');
                await loadMedia();
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

async function savePlaylist(playlistData) {
    try {
        // Coletar a ordem FINAL da preview (que tem drag & drop)
        const orderContainer = document.getElementById('playlistOrderList');
        const orderItems = Array.from(orderContainer.querySelectorAll('.playlist-order-item'));
        
        const contentOrder = orderItems.map(item => ({
            id: item.dataset.id,
            type: item.dataset.type
        }));
        
        // Coletar IDs de m√≠dias e campanhas baseado na ordem final
        const selectedMediaIds = contentOrder.filter(item => item.type === 'media').map(item => item.id);
        const selectedCampaignIds = contentOrder.filter(item => item.type === 'campaign').map(item => item.id);
        
        playlistData.mediaIds = selectedMediaIds;
        playlistData.campaignIds = selectedCampaignIds;
        playlistData.contentOrder = contentOrder;
        
        const url = playlistData.id 
            ? `${SERVER_URL}/api/playlists/${playlistData.id}`
            : `${SERVER_URL}/api/playlists`;
        
        const method = playlistData.id ? 'PUT' : 'POST';
        
        const response = await authenticatedFetch(url, {
            method: method,
            body: JSON.stringify(playlistData)
        });
        
        if (response.ok) {
            const playlist = await response.json();
            showNotification(`Playlist ${playlistData.id ? 'atualizada' : 'criada'} com sucesso!`);
            closeModal('playlistModal');
            await loadPlaylists();
            return playlist;
        } else {
            const error = await response.json();
            throw new Error(error.error);
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

    async function deletePlaylist(playlistId) {
        const confirmed = await showConfirmation(
            'Tem certeza que deseja excluir esta playlist? Esta a√ß√£o n√£o pode ser desfeita.',
            'Excluir Playlist'
        );
        
        if (!confirmed) return;
        
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/playlists/${playlistId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('Playlist exclu√≠da com sucesso!');
                await loadPlaylists();
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Sincroniza√ß√£o por Playlist
    async function syncPlaylist(playlistId) {
        const now = Date.now();
        
        // Verificar cooldown
        if (now - lastSyncClick < SYNC_COOLDOWN) {
            showNotification('Aguarde antes de sincronizar novamente', 'warning');
            return;
        }
        
        lastSyncClick = now;
        
        try {
            console.log(`Iniciando sincroniza√ß√£o da playlist: ${playlistId}`);
            
            // Verificar se h√° dispositivos ativos primeiro
            const devicesResponse = await authenticatedFetch(`${SERVER_URL}/api/devices`);
            if (!devicesResponse.ok) {
                throw new Error('Erro ao carregar dispositivos');
            }
            
            const allDevices = await devicesResponse.json();
            const playlistDevices = allDevices.filter(d => d.playlistId === playlistId && d.status === 'active');
            
            console.log(`Dispositivos ativos na playlist: ${playlistDevices.length}`);
            
            if (playlistDevices.length === 0) {
                showNotification('Nenhum dispositivo ativo nesta playlist', 'warning');
                return;
            }
            
            // Mostrar loading
            showNotification('üîÑ Sincronizando playlist...', 'info');
            
            // Fazer a sincroniza√ß√£o
            const response = await authenticatedFetch(`${SERVER_URL}/api/playlists/${playlistId}/sync`, {
                method: 'POST',
                body: JSON.stringify({
                    currentMediaIndex: 0
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Sincroniza√ß√£o bem-sucedida:', result);
                
                if (result.deviceIds && result.deviceIds.length > 0) {
                    showNotification(`Playlist sincronizada! ${result.deviceIds.length} dispositivo(s) atualizado(s)`, 'success');
                } else {
                    showNotification('Sincroniza√ß√£o conclu√≠da, mas nenhum dispositivo foi atualizado', 'warning');
                }
                
            } else {
                const error = await response.json();
                console.error('Erro na resposta do servidor:', error);
                throw new Error(error.error || 'Erro ao sincronizar playlist');
            }
            
        } catch (error) {
            console.error('Erro na sincroniza√ß√£o:', error);
            if (error.message !== 'Sess√£o expirada') {
                showNotification(error.message, 'error');
            }
        }
    }

    async function syncAllPlaylists() {
        const playlistsWithActiveDevices = currentPlaylists.filter(playlist => {
            const activeDevices = currentDevices.filter(d => d.playlistId === playlist.id && d.status === 'active');
            return activeDevices.length > 0;
        });
        
        if (playlistsWithActiveDevices.length === 0) {
            showNotification('Nenhuma playlist com dispositivos ativos encontrada', 'warning');
            return;
        }
        
        const confirmed = await showConfirmation(
            `Deseja sincronizar ${playlistsWithActiveDevices.length} playlist(s) com dispositivos ativos?`,
            'Sincronizar Todas as Playlists'
        );
        
        if (!confirmed) return;
        
        let successCount = 0;
        for (const playlist of playlistsWithActiveDevices) {
            try {
                await syncPlaylist(playlist.id);
                successCount++;
            } catch (error) {
                console.error(`Erro ao sincronizar playlist ${playlist.name}:`, error);
            }
        }
        
        showNotification(`${successCount} playlist(s) sincronizada(s) com sucesso!`);
    }

    // Anunciamentos
    async function createAnnouncement(announcementData) {
        try {
            const checkboxes = document.querySelectorAll('#announcementDevicesCheckboxes input[type="checkbox"]');
            const selectedDeviceIds = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
            
            if (selectedDeviceIds.length === 0) {
                throw new Error('Selecione pelo menos um dispositivo');
            }
            
            announcementData.deviceIds = selectedDeviceIds;
            
            const response = await authenticatedFetch(`${SERVER_URL}/api/announcements`, {
                method: 'POST',
                body: JSON.stringify(announcementData)
            });
            
            if (response.ok) {
                const announcement = await response.json();
                showNotification('Pronunciamento iniciado com sucesso!');
                closeModal('announcementModal');
                await loadAnnouncements();
                return announcement;
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function cancelAnnouncement(announcementId) {
        const confirmed = await showConfirmation(
            'Deseja cancelar este pronunciamento?',
            'Cancelar Pronunciamento'
        );
        
        if (!confirmed) return;
        
        try {
            const announcement = currentAnnouncements.find(a => a.id === announcementId);
            if (announcement) {
                announcement.status = 'cancelled';
                showNotification('Pronunciamento cancelado!');
                await loadAnnouncements();
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // Usu√°rios
    async function saveUser(userData) {
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/users`, {
                method: 'POST',
                body: JSON.stringify(userData)
            });
            
            if (response.ok) {
                const user = await response.json();
                showNotification('Usu√°rio adicionado com sucesso!');
                closeModal('userModal');
                await loadUsers();
                return user;
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    async function deleteUser(userId) {
        const confirmed = await showConfirmation(
            'Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.',
            'Excluir Usu√°rio'
        );
        
        if (!confirmed) return;
        
        try {
            const response = await authenticatedFetch(`${SERVER_URL}/api/users/${userId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showNotification('Usu√°rio exclu√≠do com sucesso!');
                await loadUsers();
            } else {
                const error = await response.json();
                throw new Error(error.error);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }

    // ==================== ATUALIZA√á√ÉO DE ESTAT√çSTICAS ====================

    function updateStats() {
        const totalDevices = currentDevices.length;
        const onlineDevices = currentDevices.filter(d => d.status === 'active').length;
        document.getElementById('statDevices').textContent = totalDevices;
        document.getElementById('statDevicesOnline').textContent = `${onlineDevices} ativos`;
        
        const totalMedia = currentMedia.length;
        const imageCount = currentMedia.filter(m => m.type === 'image').length;
        const videoCount = currentMedia.filter(m => m.type === 'video').length;
        const externalCount = currentMedia.filter(m => m.isExternal).length;
        document.getElementById('statMedia').textContent = totalMedia;
        document.getElementById('statMediaTypes').textContent = `${imageCount} img, ${videoCount} vid, ${externalCount} ext`;
        
        const totalPlaylists = currentPlaylists.length;
        const activePlaylists = currentPlaylists.filter(p => p.mediaIds.length > 0).length;
        document.getElementById('statPlaylists').textContent = totalPlaylists;
        document.getElementById('statPlaylistsActive').textContent = `${activePlaylists} ativas`;
    }

    // ATUALIZADA: Tabela de dispositivos no dashboard
    function updateDevicesTable() {
        const tbody = document.querySelector('#devicesTable tbody');
        tbody.innerHTML = '';
        
        const onlineDevices = currentDevices.filter(d => d.status === 'active');
        
        onlineDevices.forEach(device => {
            const playlistName = device.playlistId ? 
                currentPlaylists.find(p => p.id === device.playlistId)?.name || 'Playlist n√£o encontrada' : 
                'Todas as m√≠dias';
                
            const tr = document.createElement('tr');
            const lastSeen = device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'Nunca';
            
            tr.innerHTML = `
                <td>
                    <strong>${device.name}</strong>
                    ${device.mac ? `<br><small style="color: #666;">MAC: ${device.mac}</small>` : ''}
                </td>
                <td>${device.location}</td>
                <td><span class="status-active">Ativo</span></td>
                <td>${lastSeen}</td>
                <td>${playlistName}</td>

            `;
            tbody.appendChild(tr);
        });
    }

    // ==================== FUN√á√ïES ADICIONAIS ====================

    async function exportBackup() {
        try {
            const backupData = {
                timestamp: new Date(),
                users: currentUsers,
                devices: currentDevices,
                media: currentMedia,
                playlists: currentPlaylists,
                announcements: currentAnnouncements
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `media-indoor-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Backup exportado com sucesso!');
        } catch (error) {
            showNotification('Erro ao exportar backup', 'error');
        }
    }

    // Atualizar status do sistema
    function updateSystemStatus() {
        const statusElement = document.getElementById('systemStatus');
        const now = new Date();
        
        const status = {
            servidor: 'Online',
            websocket: ws && ws.readyState === WebSocket.OPEN ? 'Conectado' : 'Desconectado',
            dispositivos: `${currentDevices.filter(d => d.status === 'active').length} online`,
            ultimaAtualizacao: now.toLocaleString()
        };
        
        statusElement.innerHTML = `
            <strong>Status do Sistema:</strong><br>
            ‚Ä¢ Servidor: ${status.servidor}<br>
            ‚Ä¢ WebSocket: ${status.websocket}<br>
            ‚Ä¢ Dispositivos: ${status.dispositivos}<br>
            ‚Ä¢ √öltima atualiza√ß√£o: ${status.ultimaAtualizacao}
        `;
    }

    // ==================== EVENT LISTENERS ====================

document.addEventListener('DOMContentLoaded', function() {
    console.log('Media Indoor Admin inicializando...');
    
    // S√ì adicionar event listeners uma vez
    if (!eventListenersAdded) {
        setupEventListeners();
        eventListenersAdded = true;
    }
    
    // Verificar autentica√ß√£o MAS n√£o carregar dados automaticamente
    checkAuthentication();
});

function setupEventListeners() {
        
        // ADICIONAR event listeners apenas uma vez
        if (!eventListenersAdded) {
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                login(username, password);
            });
            
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.dataset.tab;


                    if( window.screen.width <= 768 ) {
                    const sidebarmenu = document.querySelector('.sidebar-menu');
                    sidebarmenu.classList.toggle('activeMenu');
                    }

                    document.querySelectorAll('.sidebar-menu li').forEach(li => {
                        li.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tab).classList.add('active');
                    
                    document.getElementById('page-title').textContent = this.textContent.replace(/[üìäüì∫üñºÔ∏èüìãüì¢üë•üíæ]/g, '').trim();

                    loadTabSpecificData(tab);
                });
            });
            //
            // ATUALIZADA: Formul√°rio de dispositivo
            document.getElementById('deviceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const deviceData = {
                    name: document.getElementById('deviceName').value,
                    location: document.getElementById('deviceLocation').value,
                    playlistId: document.getElementById('devicePlaylist').value || null
                };
                
                if (editingDeviceId) {
                    deviceData.id = editingDeviceId;
                }
                
                saveDevice(deviceData);
            });
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            });
            
            fileInput.addEventListener('change', handleFileUpload);

            function handleFileUpload() {
                if (fileInput.files.length > 0) {
                    const formData = new FormData();
                    Array.from(fileInput.files).forEach(file => {
                        formData.append('media', file);
                    });
                    formData.append('displayTime', document.getElementById('mediaDisplayTime').value);
                    
                    saveMedia(formData);
                }
            }
            
            document.getElementById('externalMediaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const mediaData = {
                    name: document.getElementById('externalMediaName').value,
                    url: document.getElementById('externalMediaUrl').value,
                    type: document.getElementById('externalMediaType').value,
                    displayTime: document.getElementById('externalMediaDisplayTime').value
                };
                
                saveExternalMedia(mediaData);
            });
            
            document.getElementById('editMediaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const mediaData = {
                    id: document.getElementById('editMediaId').value,
                    originalName: document.getElementById('editMediaName').value,
                    displayTime: document.getElementById('editMediaDisplayTime').value
                };
                
                const urlInput = document.getElementById('editMediaUrl');
                if (urlInput.style.display !== 'none') {
                    mediaData.path = urlInput.value;
                }
                
                updateMedia(mediaData);
            });
            
            document.getElementById('playlistForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const playlistData = {
                    name: document.getElementById('playlistName').value
                };
                
                if (editingPlaylistId) {
                    playlistData.id = editingPlaylistId;
                }
                
                savePlaylist(playlistData);
            });
            
            document.getElementById('announcementForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const announcementData = {
                    name: document.getElementById('announcementName').value,
                    mediaId: document.getElementById('announcementMedia').value,
                    displayTime: document.getElementById('announcementDisplayTime').value
                };
                
                createAnnouncement(announcementData);
            });
            
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userData = {
                    name: document.getElementById('userName').value,
                    username: document.getElementById('userUsername').value,
                    password: document.getElementById('userPassword').value,
                    role: document.getElementById('userRole').value
                };
                
                saveUser(userData);
            });
            
            document.getElementById('campaignForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const campaignData = {
                    name: document.getElementById('campaignName').value
                };
                
                if (editingCampaignId) {
                    campaignData.id = editingCampaignId;
                }
                
                saveCampaign(campaignData);
            });

            document.getElementById('addDeviceBtn').addEventListener('click', () => openDeviceModal());
            document.getElementById('addMediaBtn').addEventListener('click', () => openModal('mediaModal'));
            document.getElementById('addExternalMediaBtn').addEventListener('click', () => openModal('externalMediaModal'));
            document.getElementById('addPlaylistBtn').addEventListener('click', () => openPlaylistModal());
            document.getElementById('addAnnouncementBtn').addEventListener('click', () => openAnnouncementModal());
            document.getElementById('addUserBtn').addEventListener('click', () => openModal('userModal'));
            document.getElementById('exportBtn').addEventListener('click', exportBackup);
            document.getElementById('addCampaignBtn').addEventListener('click', () => openCampaignModal());

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            eventListenersAdded = true;
        }

            document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('resetUsername').value;
        const newPassword = document.getElementById('resetNewPassword').value;
        const confirmPassword = document.getElementById('resetConfirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            showNotification('As senhas n√£o coincidem', 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            showNotification('A senha deve ter pelo menos 6 caracteres', 'error');
            return;
        }
        
        resetPassword(username, newPassword);
    });
    }

// NOVA: Fun√ß√µes para redefinir senha
function openResetPasswordModal() {
    // closeModal('login-screen');
    openModal('resetPasswordModal');
}

async function resetPassword(username, newPassword) {
    try {
        const response = await fetch(`${SERVER_URL}/api/auth/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, newPassword })
        });

        if (response.ok) {
            showNotification('Senha redefinida com sucesso!', 'success');
            closeModal('resetPasswordModal');
            showLoginScreen();
        } else {
            const error = await response.json();
            throw new Error(error.error);
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Adicionar event listener para o formul√°rio de redefini√ß√£o
document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('resetUsername').value;
    const newPassword = document.getElementById('resetNewPassword').value;
    const confirmPassword = document.getElementById('resetConfirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showNotification('As senhas n√£o coincidem', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('A senha deve ter pelo menos 6 caracteres', 'error');
        return;
    }
    
    resetPassword(username, newPassword);
});

    // Atualizar status periodicamente
    setInterval(updateSystemStatus, 30000);
    updateSystemStatus();

    console.log('Media Indoor Admin carregado com sucesso!');



        // Mobile menu toggle
        const mobileMenu = document.querySelector('.mobile-menu');

        mobileMenu.addEventListener('click', () => {
            const sidebarmenu = document.querySelector('.sidebar-menu');

            sidebarmenu.classList.toggle('activeMenu');
        });
// ==================== FUN√á√ïES DE CAMPANHAS ====================

// Abrir modal de campanha
function openCampaignModal(campaign = null) {
    editingCampaignId = campaign ? campaign.id : null;
    const title = document.getElementById('campaignModalTitle');
    
    title.textContent = campaign ? 'Editar Campanha' : 'Criar Campanha';
    
    if (campaign) {
        document.getElementById('campaignId').value = campaign.id;
        document.getElementById('campaignName').value = campaign.name;
    } else {
        document.getElementById('campaignForm').reset();
    }
    
    renderCampaignMediaCheckboxes(campaign ? campaign.mediaIds : [], campaign ? campaign.mediaOrder : []);
    openModal('campaignModal');
}

// Renderizar checkboxes de m√≠dias para campanha
function renderCampaignMediaCheckboxes(selectedMediaIds = [], mediaOrder = []) {
    const container = document.getElementById('campaignMediaCheckboxes');
    container.innerHTML = '';
    
    if (currentMedia.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhuma m√≠dia dispon√≠vel</p>';
        return;
    }
    
    let mediaToShow = currentMedia;
    // if (mediaOrder.length > 0) {
    //     mediaToShow = mediaOrder.map(id => currentMedia.find(m => m.id === id)).filter(Boolean);
    // } else {
        mediaToShow.sort((a, b) => (a.order || 0) - (b.order || 0));
    // }
    
    mediaToShow.forEach(mediaItem => {
        const div = document.createElement('div');
        div.className = 'media-checkbox-item';
        div.draggable = true;
        div.dataset.id = mediaItem.id;
        
        const isChecked = selectedMediaIds.includes(mediaItem.id);
        const mediaTypeIcon = mediaItem.mediaType === 'youtube' ? 'üì∫' : 
                           mediaItem.mediaType === 'website' ? 'üåê' : 
                           mediaItem.type === 'image' ? 'üñºÔ∏è' : 'üé•';
        
        div.innerHTML = `
            <input type="checkbox" value="${mediaItem.id}" ${isChecked ? 'checked' : ''}>
            <span class="drag-handle">‚†ø</span>
            <span style="flex: 1;">
                <strong>${mediaItem.originalName}</strong>
                <br>
                <small style="color: #666;">
                    ${mediaTypeIcon} ${mediaItem.mediaType || 'upload'} 
                    ‚Ä¢ ${mediaItem.displayTime}s
                    ${mediaItem.type ? `‚Ä¢ ${mediaItem.type}` : ''}
                </small>
            </span>
        `;
        container.appendChild(div);
    });
    
    initCampaignDragAndDrop();
}

// Inicializar drag and drop para campanhas
function initCampaignDragAndDrop() {
    const container = document.getElementById('campaignMediaCheckboxes');
    let draggedItem = null;
    
    container.querySelectorAll('.media-checkbox-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', function() {
            this.style.opacity = '1';
            draggedItem = null;
        });
        
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        item.addEventListener('drop', function(e) {
            e.preventDefault();
            if (draggedItem && draggedItem !== this) {
                const container = this.parentNode;
                if (draggedItem.parentNode === container) {
                    const fromIndex = Array.from(container.children).indexOf(draggedItem);
                    const toIndex = Array.from(container.children).indexOf(this);
                    
                    if (fromIndex < toIndex) {
                        container.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        container.insertBefore(draggedItem, this);
                    }
                }
            }
        });
    });
}

// Salvar campanha
async function saveCampaign(campaignData) {
    try {
        const checkboxes = document.querySelectorAll('#campaignMediaCheckboxes input[type="checkbox"]');
        const mediaItems = Array.from(document.querySelectorAll('#campaignMediaCheckboxes .media-checkbox-item'));
        
        const selectedMediaIds = [];
        const mediaOrder = [];
        
        mediaItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            const mediaId = item.dataset.id;
            
            if (checkbox.checked) {
                selectedMediaIds.push(mediaId);
                mediaOrder.push(mediaId);
            }
        });
        
        campaignData.mediaIds = selectedMediaIds;
        campaignData.mediaOrder = mediaOrder;
        
        const url = campaignData.id 
            ? `${SERVER_URL}/api/campaigns/${campaignData.id}`
            : `${SERVER_URL}/api/campaigns`;
        
        const method = campaignData.id ? 'PUT' : 'POST';
        
        const response = await authenticatedFetch(url, {
            method: method,
            body: JSON.stringify(campaignData)
        });
        
        if (response.ok) {
            const campaign = await response.json();
            showNotification(`Campanha ${campaignData.id ? 'atualizada' : 'criada'} com sucesso!`);
            closeModal('campaignModal');
            await loadCampaigns();
            return campaign;
        } else {
            const error = await response.json();
            throw new Error(error.error);
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// Carregar campanhas
async function loadCampaigns() {
    try {
        const response = await authenticatedFetch(`${SERVER_URL}/api/campaigns`);
        if (response.ok) {
            currentCampaigns = await response.json();
            renderCampaignsList();
        }
    } catch (error) {
        console.error('Erro ao carregar campanhas:', error);
        showNotification('Erro ao carregar campanhas', 'error');
    }
}

// Renderizar lista de campanhas
function renderCampaignsList() {
    const container = document.getElementById('campaignsList');
    container.innerHTML = '';
    
    if (currentCampaigns.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma campanha criada</p>';
        return;
    }
    
    currentCampaigns.forEach(campaign => {
        const campaignElement = document.createElement('div');
        campaignElement.className = 'card';
        campaignElement.style.marginBottom = '15px';
        
        const mediaCount = campaign.mediaIds.length;
        
        campaignElement.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 10px 0;">${campaign.name}</h3>
                    <p style="margin: 0 0 10px 0; color: #666;">
                        üìÅ ${mediaCount} m√≠dia(s) na campanha
                    </p>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-warning btn-sm" onclick="openCampaignModal(${JSON.stringify(campaign).replace(/"/g, '&quot;')})">
                            Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCampaign('${campaign.id}')">
                            Excluir
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(campaignElement);
    });
}

// Excluir campanha
async function deleteCampaign(campaignId) {
    const confirmed = await showConfirmation(
        'Tem certeza que deseja excluir esta campanha? Esta a√ß√£o n√£o pode ser desfeita.',
        'Excluir Campanha'
    );
    
    if (!confirmed) return;
    
    try {
        const response = await authenticatedFetch(`${SERVER_URL}/api/campaigns/${campaignId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('Campanha exclu√≠da com sucesso!');
            await loadCampaigns();
        } else {
            const error = await response.json();
            throw new Error(error.error);
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

// ==================== TABS DE M√çDIAS ====================

// Inicializar tabs de m√≠dias
function initMediaTabs() {
    document.querySelectorAll('.media-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Remover active de todas as tabs
            document.querySelectorAll('.media-tab').forEach(t => t.classList.remove('active'));
            // Adicionar active na tab clicada
            this.classList.add('active');
            
            // Filtrar m√≠dias
            const type = this.dataset.type;
            filterMediaByType(type);
        });
    });
}

// Filtrar m√≠dias por tipo
function filterMediaByType(type) {
    const mediaItems = document.querySelectorAll('.media-list-item');
    
    mediaItems.forEach(item => {
        const mediaId = item.dataset.id;
        const mediaItem = currentMedia.find(m => m.id === mediaId);
        
        if (!mediaItem) return;
        
        let shouldShow = false;
        
        switch(type) {
            case 'all':
                shouldShow = true;
                break;
            case 'image':
                shouldShow = mediaItem.type === 'image' && !mediaItem.isExternal;
                break;
            case 'video':
                shouldShow = mediaItem.type === 'video' && !mediaItem.isExternal;
                break;
            case 'external':
                shouldShow = mediaItem.isExternal;
                break;
        }
        
        item.style.display = shouldShow ? 'flex' : 'none';
    });
}
</script>
</body>
</html>